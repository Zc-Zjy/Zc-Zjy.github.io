<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>SpringCloud学习笔记 | 小Z成长录😀丶</title><meta name="keywords" content="工作技能,后端,Spring"><meta name="author" content="十七"><meta name="copyright" content="十七"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#e8dfc4"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="SpringCloud学习笔记"><meta name="application-name" content="SpringCloud学习笔记"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#e8dfc4"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloud学习笔记"><meta property="og:url" content="https://zc-zjy.github.io/2024/11/27/SpringCloud学习笔记/index.html"><meta property="og:site_name" content="小Z成长录😀丶"><meta property="og:description" content="一、架构体系   1、说明（1）注册中心（配置中心）、网关、各个服务启动，每个服务都会向注册中心注册，注册中心将每个服务的信息记录到它的数据库中，此时，每个服务和注册中心会建立心跳连接（相当于每隔一段时间，每个服务就会主动告诉注册中心，自己没有出现异常，没有挂掉），这样防止服务挂掉后，注册中心没有"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://zc-zjy.github.io/img/page_background/cover_background_light.jpg"><meta property="article:author" content="十七"><meta property="article:tag" content="Java,Spring,软件开发技术,Vue"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://zc-zjy.github.io/img/page_background/cover_background_light.jpg"><meta name="description" content="一、架构体系   1、说明（1）注册中心（配置中心）、网关、各个服务启动，每个服务都会向注册中心注册，注册中心将每个服务的信息记录到它的数据库中，此时，每个服务和注册中心会建立心跳连接（相当于每隔一段时间，每个服务就会主动告诉注册中心，自己没有出现异常，没有挂掉），这样防止服务挂掉后，注册中心没有"><link rel="shortcut icon" href="/img/dog.png"><link rel="canonical" href="https://zc-zjy.github.io/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"小Z成长录😀丶","mode":"local","switchBtn":true,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"api","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["💢 励志成为技术大牛的一名小白"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":true,"limitCount":50,"languages":{"author":"作者: 十七","link":"链接: ","source":"来源: 小Z成长录😀丶","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '小Z成长录😀丶',
  title: 'SpringCloud学习笔记',
  postAI: '',
  pageFillDescription: '一、架构体系, 二、SpringCloud组件, 三、单体演变为微服务过程, 四、微服务架构体系, 五、其他问题, 1、雪崩问题, 2、分布式事务, 3、消息队列的使用, 4、处理MQ消息重复投递问题, 5、使用延迟消息插件, 6、抽取MQ工具一架构体系说明注册中心配置中心网关各个服务启动每个服务都会向注册中心注册注册中心将每个服务的信息记录到它的数据库中此时每个服务和注册中心会建立心跳连接相当于每隔一段时间每个服务就会主动告诉注册中心自己没有出现异常没有挂掉这样防止服务挂掉后注册中心没有及时更新服务信息导致调用方调用失败网关启动之后也会将自己注册到注册中心然后从注册中心拉取每个服务的注册信息到内存中这里可以使用动态路由相关信息查看网关的动态路由设置前端发送请求请求会先到网关网关使用过滤器去校验请求校验通过之后会根据请求路径从内存中找到相对应的服务然后将请求转发给服务服务在自己数据库进行业务处理之后返回结果例子说明用户在登录页进行登录用户发送登录请求这个请求在网关配置文件中配置的是白名单白名单不需要校验可以直接通过的请求该请求到达网关网关不进行校验直接从内存中匹配匹配到是用户服务登录校验还是在用户服务进行因此将请求转发给用户服务用户服务收到请求进行登录校验校验通过之后生成返回给前端先返回给网关再返回给前端用户登录成功之后注意这里如果项目中登录打了断点是成功不了的这是因为网关降级进行查找商品列表发送请求网关收到请求因为该请求没有设置白名单需要进行校验校验是否有效无效返回无效的校验通过之后解析为用户信息然后从内存中匹配路由列表匹配到的是商品服务然后将用户信息重新设置到请求头中再将请求转发给商品服务如果商品服务是集群因为网关中设置了负载均衡所以网关会根据负载均衡规则将请求转发给商品服务集群中的某一个商品服务商品服务接收到请求会通过公共包中写好的拦截器设置好用户信息这个拦截器不做别的事情只获取请求头中用户信息存入供后面使用再从数据库中查找商品列表返回给网关网关将商品列表返回给前端如果商品服务中打了断点也不会成功因为网关降级用户查询购物车列表查询购物车也要查询商品这里就是服务之间的调用用户查询购物车列表发送请求网关收到请求同样需要校验并解析校验通过之后将解析出来的用户信息重新设置到请求头转发给购物车服务同样购物车服务收到请求也会先执行公共包中写好的拦截器设置请求头中的用户信息然后购物车服务查询购物车列表此时需要查找商品信息因为商品信息在商品服务那只能由商品服务来进行查询所以购物车服务调用商品服务本来这里可以使用来发送请求给商品服务因为都是基于协议但是这种做法比较麻烦所以可以使用来简化这个过程底层也是使用但是会根据接口定义自动生成请求然后发送给商品服务购物车服务先通过提供好的接口将用户信息设置到请求头中再发送请求给商品服务商品服务接收到请求同样先执行公共包中写好的拦截器获取用户信息再进行商品的查询然后返回给购物车服务购物车服务接收到商品服务返回的商品列表将商品列表返回给网关网关将商品列表返回给前端二组件注册中心服务注册发现公司产品被集成在中一般用于应用公司产品被集成在中不限制微服务语言公司产品被集成在中用于应用配置中心统一配置管理负载均衡网关统一网关路由服务调用服务远程调用服务链路监控流控降级保护三单体演变为微服务过程具体的文档教程请点击本笔记中所用到的所有资料可在这里获取链接提取码说明将单体项目改为微服务项目什么时候需要使用单体项目什么时候使用微服务创业型项目先采用单体架构快速开发快速试错随着规模扩大逐渐拆分确定的大型项目资金充足目标明确可以直接选择微服务架构避免后续拆分的麻烦单体项目怎么拆分为微服务高内聚每个微服务的职责要尽量单一包含的业务互相关联度高完整度高低耦合每个微服务的功能要相对独立尽量减少与其他微服务的依赖拆分方法一般有两种纵向拆分按照业务模块来拆分横向拆分抽取公共服务提高复用性有两种微服务结构第一种是独立每个微服务都是一个独立的每个都有自己的文件每个都有自己的数据库每个都有自己的启动类相当于每个微服务都是一个项目有几个微服务就有几个项目第二种是聚合每个微服务都是一个独立的每个都有自己的文件每个都有自己的数据库但是这些共用一个启动类相当于一个项目中有多个微服务模块只有一个项目拆分过程单体项目地址点击前端地址点击已分离项目地址点击这里我们使用纵向拆分和第二种微服务结构将用户商品购物车订单支付等模块拆分为五个不同的微服务这里只选商品服务进行演示其他类似在项目根目录创建一个起名为引入所需依赖和构建插件从单体项目中进行拷贝依赖数据库单元测试构建插件可以不用引入从单体项目中拷贝分别创建启动类启动类上面别忘了加扫描注解包将单体项目中的三个配置文件拷贝过来并修改需要修改的配置这里需要修改这里需要修改这里需要修改这里需要修改这里需要修改黑马商城商品服务接口文档这里需要修改黑马商城商品服务接口文档这里需要修改虎哥这里需要修改为你的包路径将单体项目关于商品的实体类分别拷贝过来按照这个顺序拷贝类类类实现类中需要修改方法中第一行值修改为实际的路径类这里解释类中的注解这个注解是提供的用于自动生成一个包含所有字段和带有注解的字段的构造函数在这个示例中类使用了注解会自动生成一个构造函数该构造函数接受和两个参数并初始化它们字段不是因此不会出现在生成的构造函数中初始化数据库启动商品服务测试可以在下面图片中启动要启动多个商品服务集群这样启动启动成功后访问接口文档测试在拆分购物车服务的时候因为购物车服务需要查询商品信息爆红的地方先不用管将其注释然后将实现类中的方法中第一行注释掉改为现在我们来处理两个服务间如何调用我们看之前单体项目都是由前端发送请求到后端所以我们可以模仿单体项目发送请求的方式使用来发送请求即在购物车服务使用发送请求给商品服务在配置类中注入这里在启动类中注入因为启动类也是配置类声明为在购物车服务的类中注入注入方式一构造器注入前提要在类上面使用注解注入方式二使用注解将方法中原来查询商品的代码注释掉改为使用商品服务的接口地址为形式请求路径也就是商品服务的接口地址请求方式请求参数这里需要传字节码因为这里我们需要传类型我们不可能传所以这里使用来传类型的字节码它是泛型的引用这个参数是个下面的对应上面接口地址中的参数名是新增的方法用于构建一个是工具包中的方法用于将集合以分隔拼接成字符串进行判断如果返回结果不为则直接返回查询失败直接返回如果为空则直接返回重启购物车服务进行测试因为我们在实际开发中不可能直接使用发送这种请求并且可能会涉及集群上面方式不可行因此我们使用注册中心通过服务名来访问服务服务自己百度或者官网这里不再讲解在每个服务中引入依赖这个包包含了服务的注册和发现了在配置文件中配置配置服务的名称如商品服务就是地址默认为本地注意这里不能配必须配数字重新启动服务访问管理平台可以查看服务已经注册到注册中心了为了注册中心定义了一个标准也就是一个接口所有注册中心都实现了这个接口我们在类中注入接口注入方式一构造器注入前提要在类上面使用注解注入方式二使用注解将之前的相关代码全注释了在查询商品信息那使用改了之后重启测试根据服务名获取注册中心中的服务实例列表这里实例名对应配置文件中配置的服务名比如要调用商品服务就是使用随机负载均衡方式来从服务实例列表中获取一个服务发送请求如果为空则直接返回现在修改之后还是太繁琐了因为只要涉及到服务间的调用都要写一遍上面的代码不可取我们进行优化改用方式来简化是一个声明式的客户端是在公司开源的基础上改造而来的官方地址其作用就是基于的常见注解帮我们优雅的实现请求的发送引入和负载均衡依赖负载均衡在启动类上添加注解开启创建包并在包下创建接口接口上添加注解并指定服务名然后在接口中定义方法方法上添加注解并指定请求路径我们不用管这个方法的实现它是通过动态代理来实现的的意思是告诉这个接口是调用服务的这里对应商品服务中的的接口将上面关于的相关代码都注释在类中注入接口并使用注入注入方式一构造器注入前提要在类上面使用注解注入方式二使用注解使用直接调用接口中的方法查询商品信息即可因为发送请求是通过接口专门发送请求的接口发的这个接口默认实现是这个自带的这个类发送请求每次都要创建连接利用流的方式去作读写效率比较低我们需要优化我们采用连接池的方式对请求做了优雅的伪装不过其底层发起请求依赖于其他的框架这些框架可以自己选择包括以下三种默认实现不支持连接池支持连接池支持连接池具体源码可以参考类中的成员变量开启连接池之后可以查看该变量是否变成对应的连接池这里选择注意如果和两个都使用只会生效引入依赖在配置文件中开启连接池的功能重启之后查看类中的成员变量是否变成对应的连接池配置假如有多个服务都需要查询商品服务的数据那每个服务都要在自己服务中写一遍接口太繁琐不可行有两种解决方式第一种在服务写接口也就是说由服务自己提供在服务下建个分别是其中就是用来给其他服务调用的然后其他需要调用服务的直接引用和的依赖坐标即可第二种在总的项目下新建一个专门写各个服务的然后其他服务需要调用哪个直接引用这个的依赖坐标即可这里我们使用第二种在总的项目下新建一个新的叫在的文件中引入关于相关的依赖负载均衡公共包在中新建两个包和将原来的类和接口移动到的和中如果是复制粘贴记得删除原来的和将购物车服务的文件中引入的依赖坐标重启发现报错是因为购物车服务中扫描器只能扫描到它自己规定的包路径而包中的类是扫描不到的所以无法注入到容器中解决办法是在购物车服务启动类上的指定扫描接口包路径有两种指定方式第一种指定所在包路径第二种指定字节码可指定多个日志输出配置只会在所在包的日志级别为才会输出日志而且其日志级别有级不记录任何日志信息这个默认值仅记录请求的方法以及响应状态码和执行时间在的基础上额外记录了请求和响应的头信息记录所有请求和响应的明细包括头信息请求体元数据由于默认的日志级别就是所以默认看不到请求日志我们查看配置文件由上面配置我们可以知道不管是哪个服务还是只要包路径以开头其日志级别都是但是为什么还没日志输出因为默认的日志级别为不输出任何信息我们需要修改的日志级别在新建包新建配置类这个配置类需要被容器扫描到有两种配置方式第一种配置方式局部配置在的某个接口中的注解中指定配置类第二种配置方式全局配置我们可以在注解上指定包扫描路径配置发送请求日志输出首先在中创建日志配置类在下面注解中将配置类配置进去即可拆分用户服务的时候注意类和相关的都是属于用户服务还需要密钥文件类类工具类以及配置文件中下面的配置密钥文件生成的密钥可以看到打开是乱码是因为被加密过了密钥也需要加密的读取密钥文件的配置信息里面的是密钥文件的密码密钥文件本身是需要密码的拆分交易服务时牵扯到服务间的调用需要在编写接口可以去对应的中查看是否有需要的接口如果有直接复制粘贴即可拆分支付服务时也有服务间的调用测试就在支付服务的中将下面代码粘贴进去测试测试用的查询支付单现在面临两个问题问题一现在后端有这么多服务每个服务都有一个端口前端如何调用问题二服务间需要用到用户信息即用户上下文这个服务间要怎么传递和获取解决问题一需要使用网关查看最上面一架构体系中的图网关就是网络的关口负责请求的路由转发身份校验新建一个网关服务引入依赖网关服务依赖因为网关服务也需要注册到注册中心所以也需要的依赖因为网关在转发请求时也会用到负载均衡所以也需要负载均衡的依赖负载均衡创建网关服务启动类新建配置文件这里其他服务实际上也需要配置的默认配置是本地所以其他服务没有配置路由属性路由规则自定义唯一就行路由目标微服务对应服务名称表示负载均衡路由断言路由条件满足条件时路由到目标微服务路径匹配以开头的请求都路由到目标微服务可以查看中的路径过滤器对请求或响应进行处理每个服务接收请求之前的过滤器多个映射简化方式全局过滤器对所有路由生效配置文件中的路由属性对应类型是配置文件中的路由断言提供了种基本的实现配置文件中的过滤器网关中已经提供好了种路由过滤器每种过滤器都具有独特的作用具体可查看官网查看这种过滤器使用方式直接在配置文件中配置即可生效使用例如配置单个过滤器配置过滤器作用是在当前请求中添加一个请求头是是测试在购物车服务的查询购物车列表接口中添加注解获取请求头查询购物车列表访问可以查看控制台输出信息上面这种使用方式针对的是某个服务进行配置如果想配置全局过滤器让所有服务都有该过滤器可以这样配全局过滤器配置现在网关服务已经建好需要做登录校验先分析网关请求处理流程说明前端请求到达网关网关中的根据请求找到匹配的路由并存入上下文然后再把请求交给处理默认实现是它会加载我们在配置文件中配置的多个过滤器放入到集合并排序形成过滤器链依次执行这个过滤器先执行方法然后最后一个过滤器将请求转发到微服务微服务处理完后再返回到再倒叙执行每个过滤器中的方法根据上面的过程我们要做登录校验需要自定义一个过滤器去做校验而且需要将用户信息也就是解析的传给各个用户信息这个自定义的过滤器还得做排序必须在这个过滤器之前执行因为这个过滤器的作用就是负责将请求转发到各个微服务自定义过滤器接口局部单个过滤器作用于配置文件中任意服务指定的路由默认不生效要配置到配置文件中的服务路由后才生效就比如上面提到的种过滤器就是网关为我们提供好的都是基于这个接口实现的要想自定义一个单个局部过滤器并不是直接去实现接口而是实现工厂接口为什么要这样做因为局部单个过滤器需要在配置文件中指定配置单个过滤器或者全局过滤器配置它指定的格式是过滤器名参数参数值可以发现过滤器名是固定的但是参数有可能不同所以我们需要用过滤器工厂根据参数去帮我们动态生成每一个过滤器这里还特别需要注意一点就是给过滤器起名的时候必须遵循过滤器名后缀无参过滤器非全局无参过滤器泛型里就是哪个服务配置了这个过滤器哪个服务接收请求之前才会执行注意所有过滤器名字必须以格式来命名然后配置里面就使用来配置第一种这里本来是要的但是我们还需要排序所以使用到了装饰类装饰模式第二种也可以自己在下面一个内部类去分别实现和接口再在这里一般都会使用第一种方式然后在配置文件中配置注意要使用别忘了放开注解配置单个过滤器或者全局过滤器配置有参过滤器获取配置参数自定义配置属性成员变量名称很重要下面会用到参数参数参数将变量名称依次返回顺序很重将来读取参数时需要按顺序获取将字节码传递给父类父类负责帮我们读取配置配置文件根据上面配置的顺序依次对应配置单个过滤器对应对应对应或者全局过滤器配置对应对应对应接口全局过滤器作用范围是所有路由只要新建并且声明后自动生效不需要在配置文件指定自定义一个类去实现接口注意这里还需要实现另一个接口这个接口是用来排序的全局过滤器必须实现接口每个微服务接收请求之前都会执行接口是为了排序也必须实现要生效就把过滤器注入到容器放开下面注解请求上下文包含整个过滤器链内共享数据例如等过滤器链当前过滤器执行完后要调用过滤器链中的下一个过滤器返回的值越小优先级越高现在开始做网关登录校验需要将密钥文件类类设置用户白名单的类工具类以及下面配置文件中的配置复制粘贴过来这里设置的白名单表示任何人都可以访问对应类需要注意类会报错是因为容器没有扫描到它它不是一个的管理可以只用或者注解将它注入容器成为新建自定义登录校验过滤器获取判断是否需要做登录拦截放行获取校验并解析解释下这里为什么要捕获异常因为方法如果出现异常会把异常抛出这里我们不希望它将异常抛出我们希望设置一个状态码让前端知道是因为没有权限是因为解析失败所以这里我们要捕获这个方法中出现的所有异常然后重新设置响应码拦截设置响应状态码为保存并传递用户信息放行判断校验这里说明这里不能使用普通的字符串校验因为这里的路径例如是格式如果使用字符串校验那请求这种也会被校验成功不可行我们这里要用到特殊的校验路径的方式给我们提供的校验工具现在我们已经完成了网关登录校验但是还有一点需要做处理就是网关登录校验成功之后会把解析好的用户信息转发给其他服务那这些微服务要怎么获取这个用户信息呢所以我们需要自定义一个拦截器专门获取用户信息因为每个服务都会用到这个拦截器所以我们在公共包中去新建在公共包中新建因为能执行到这里说明已经校验通过了所以这个拦截器只做一件事获取用户信息获取登陆用户信息判断是否获取了用户信息如果有存入清除中的用户信息自定义的拦截器需要添加到配置中再新建一个配置类将这个拦截器配置进去这里用到了注解需要说明因为不止微服务用到了公共包可能其他不需要使用到这个拦截器的包也使用到了公共包以防万一我们可以使用条件注解当类路径下存在类时才会加载这个配置类否则不加载这样就不会影响其他包了我们发现这个拦截器是在公共包中的其他各个微服务是扫描不到的所以根据自动配置原理我们需要在包下的文件中配置这个拦截器服务间的调用也需要传递解析出来的用户信息而服务间的调用是通过来调用的我们需要用到中提供的拦截器接口所有由发起的请求都会先调用这个拦截器处理请求我们在中的包下新建一个配置类这个方法中的参数是它提供方法供我们修改请求头因为这个中的类是无法被容器扫描到的又因为它是个配置类所以我们需要在每个使用了的服务的启动类上面的注解中添加这个配置类注意记得将之前被注释的改回来现在来讲配置文件如果需要将配置文件管理起来可以使用配置中心自带了配置中心案例我们继续上面的项目现在将一些共享的配置添加到配置中心去包括日志等配置访问进入后台管理系统如果没有启动就启动目前启动的是单机模式启动命令进入配置管理新建三个配置文件表单中的分组为默认描述自定义格式为其他不用填如下图所示这里读取项目配置文件中的属性如果没有默认为其他同理这里读取项目配置文件中的属性如果没有默认为这里读取项目配置文件中的属性如果没有默认为黑马商城接口文档黑马商城接口文档虎哥如果没有设置默认值的必须在项目配置文件中配置然后将项目中原来的相对应的配置删除也可以备份一份再删除修改之后的配置文件内容如下配置下面配置对应配置中心的共享配置配置数据库配置黑马商城购物车服务接口文档黑马商城购物车服务接口文档然后这里先讲下项目的启动流程它是先加载配置文件然后再进行的初始化而现在我们用的是它启动之后会先拉取配置中心的配置信息然后进行的上下文初始化才会进行的启动流程但是它先拉取配置中心这个配置中心的地址是在项目配置文件中的它不知道配置中心的地址怎么拉取呢我们可以引入依赖然后在项目中新建一个配置文件将配置中心的地址以及相关的信息配置进去有了这个配置文件启动之后就会先读取这个配置文件再拉取配置中心的配置依赖配置管理依赖读取文件依赖对应下面图片中的对应下面图片中的服务如果是本地可以不配默认已经是本地了配置配置管理中的配置文件的后缀名对应下面图片中的配置配置管理中的配置文件现在我们来将配置热更新当修改配置文件中的配置时微服务无需重启即可使配置生效必要的条件有两个条件一中要有一个与微服务名有关的配置文件项可以省略条件二微服务中要以特定的方式读取需要热更新的配置属性读取方式一读取方式二现在我们修改项目项目有个业务是购物车的限定数量是写死在代码中的我们需要将它改为热更新我们先新建一个读取配置的类就是上面条件二中的类然后我们修改类的方法用户购物车课程不能超过然后我们去配置中心新建一个配置这里的起名要符合上面条件一中的要求动态路由配置现在微服务的配置都是写死在网关服务中的那么要想实现动态路由配置该怎么办呢要实现动态路由首先要将路由配置保存到当中的路由配置变更时推送最新的配置到网关服务实时更新网关中的路由信息我们需要做两件事情监听配置变更的消息和当配置变更时将最新的路由信息更新到网关路由表这两件事情可以参考官网中监听配置下面是官网提供的示例这里是讲解配置中心地址要加载的配置文件要加载的配置文件获取路由配置信息添加监听器上面我们可以看到它先要获取一次路由信息到内存再进行监听上面的示例太麻烦了我们不用按照上面示例来因为我们之前引入了配置管理的依赖它帮我们自动配置了我们只需要使用它提供的接口即可我们先在网关服务中引入依赖配置管理依赖读取文件依赖然后我们新建一个配置文件然后将网关服务原来的配置文件修改为我们在网关服务新建一个包然后新建一个类对应配置中心中的配置文件名这里为什么要文件因为文件解析比较容易文件解析比较麻烦对应配置中心的配置文件分组保存需要删除的这里使用集合因为集合不会重复在的初始化之后执行项目启动时先拉取一次配置并且添加配置监听器监听到配置变更需要去更新路由表第一次读取到配置也需要更新到路由表更新路由表监听到路由信息后需要用到接口类更新路由表更新路由到路由表如果路由重复则会覆盖旧的路由根据路由删除路由表中的路由解析配置信息转为删除旧的路由表方法需要用到对象这里表示将包装成对象表示执行删除方法如果没有方法是不会执行删除方法的添加新的路由表保存路由方便下次删除重启服务因为现在网关服务中是没有任何其他微服务的地址信息的路由信息所以没办法做任何请求我们访问配置中心管理后台在配置管理中新建一个文件名字要与上面代码中的保持一致按照上面的格式将其他服务信息也加进去不用重启网关服务直接查看项目控制台或者直接发送任何请求都可以如果还是访问不了需要等待一段时间因为这个需要等待一会才能生效四微服务架构体系这个图就是微服务的架构体系图服务之间通过来互相调用各个微服务将自己信息注册到注册中心进行来进行服务治理前端发送请求给网关网关进行身份验证和请求路由转发可以通过来进行动态地配置管理五其他问题雪崩问题什么是雪崩微服务调用链路中的某个服务故障引起整个链路中的所有微服务都不可用比如说商品服务处理时间比较长或者故障了有个请求发送给网关网关转发给购物车服务购物车服务调用了服务这是正常的然后又有请求转给购物车服务购物车服务调用了商品服务处理慢或者故障了需要等很长时间如果此时突然来了大量请求都需要购物车服务调用商品服务高并发场景下这些请求都需要等很长时间而资源是有限的这些有限的资源被这些请求占用着后面再来请求处理别的就处理不了了而其他需要调用商品服务的服务也会受到影响调用不了商品服务整个微服务就受到影响那为什么这个微服务的问题要叫雪崩呢因为这个微服务的问题和雪崩一样雪崩是因为一点声音或者一片小雪花就能产生雪崩雪崩问题产生的原因是什么微服务互相调用服务提供者出现故障或阻塞服务调用者没有做好异常处理导致自身故障调用链中的所有服务级联失败导致整个集群故障解决问题的思路有哪些尽量避免服务出现故障或阻塞保证代码的健壮性保证网络畅通能应对较高的并发请求解决雪崩问题的方案第一个方案请求限流属于服务保护方案请求限流限制访问微服务的请求的并发量避免服务因流量激增出现故障如下图所示第二个方案线程隔离属于服务保护方案线程隔离舱壁模式模拟船舱隔板的防水原理通过限定每个业务能使用的线程数量而将故障业务隔离避免故障扩散第三个方案服务熔断属于服务保护方案服务熔断由断路器统计请求的异常比例或慢调用比例如果超出阈值则会熔断该业务则拦截该接口的请求背景由来在使用线程隔离基础上如下图假如服务中有两个业务分别需要调用服务和服务我们将服务中的业务分别设置线程数业务设置线程数为业务设置线程数为当一个请求到服务的业务它先领取一个线程在去调用服务另一个请求到服务的业务先领取线程再调用服务这就是线程隔离此时服务故障了来了四个请求都处理服务的业务明知服务故障还要去调用服务就浪费资源了所以这里需要服务熔断当得知服务故障了就将其断开之前遇到的在登录校验业务的地方打上断点或者在服务之间打上断点就请求不了的问题就是这个然后这里熔断期间所有请求快速失败全部走方法在服务提前写好返回友好的提示而不会等待服务的响应从而避免了故障的传播服务保护技术这里选用来讲解是阿里巴巴开源的一款微服务流量控制组件官网地址先从官网找到启动控制台项下载包并启动启动命令官网中有启动成功后访问可以看到控制台界面在服务中引入依赖这个依赖中已经包含了官网中让引入的依赖在服务的中配置指定控制台地址重启服务然后访问服务的任意接口控制台就会显示服务接口的信息注意这里得访问服务接口之后控制台才会有信息介绍控制台簇点链路就是单机调用链路是一次请求进入服务后经过的每一个被监控的资源链默认会监控的每一个接口即接口因为默认监控的是接口有时接口会采用风格也就是说一个接口可能存在请求方式不同所以我们需要设置用用请求方式来区分开启请求方式区分我们查看我们的项目购物车服务中的接口它里面调用了商品服务中的接口假设接口中还调用了服务然后商品服务的接口性能低或者宕机了为了保护项目我们需要设置请求限流线程隔离和服务熔断在簇点链路中设置请求限流在簇点链路中我们选择接口在后面点击流控按钮在弹出的窗口中不用去修改任何东西只用修改那个阈值这里介绍下每秒钟请求的数量比如填了代表这个接口每秒钟只能请求个测试可以使用测试工具这个测试工具和使用方法在已分离的项目地址目录中在簇点链路中设置线程隔离同请求隔离一样也是点击流控按钮这次我们选择阈值类型为并发线程数例如这个接口的并发线程数设置为设置为说明这个接口每秒钟可以请求个请求这样设置了之后假如有大量请求去请求接口都不会影响购物车服务的其他接口性能如果不设置就会影响到购物车服务的其他接口性能这里我们还需要完善一点就是如果大量请求都去请求这个接口虽然此时购物车服务的其它接口不会被影响但是这个接口的资源被占满之后就会直接报错不是很友好我们需要给这个接口添加方法这样一来当这个接口的请求超过个时就会触发方法返回友好提示相当于就是只对这个接口中调用商品服务接口这部分做线程隔离不对整个接口做线程隔离但是我们发现在控制台中只有的请求接口是簇点链路可以设置线程隔离所以我们需要将接口也设置成簇点链路资源让它可以设置线程隔离我们需要在购物车服务的配置文件中开启配置服务调用了服务就在服务配置开启的支持因为我们需要写的商品服务的方法所以我们需要在下新建包并新建一个类实现的方式有两种实现接口无法对远程调用的异常做处理实现接口可以对远程调用的异常做处理一般都选择这种方式因为是针对接口写的方法所以泛型中是查询商品失败返回空集合然后在配置类中将类注册为然后将接口的注解中添加属性并指向类省略这样当商品服务接口调用失败时就会触发方法返回空集合我们也可以去控制台对这个接口中调用商品服务接口这部分进行配置了在簇点链路中设置服务熔断思路是由断路器统计服务调用的异常比例慢请求比例如果超出阈值则会熔断该服务即拦截访问该服务的一切请求而当服务恢复时断路器会放行访问该服务的请求上图说明断路器有三种状态分别是断路器默认状态是当服务调用失败比例超过阈值时断路器会变成状态此时所有请求都会被拦截会执行方法当断路器变成状态后经过一段时间断路器会变成状态此时它会尝试放行一个请求如果这个请求调用成功则断路器会变成状态如果这个请求调用失败则断路器会变成状态在簇点链路中选择某个接口点击熔断按钮在弹出的窗口中最大是最大响应时间比如填了然后熔断策略选择了慢调用比例代表如果请求这个接口超过了就说明这个接口是慢的然后比例阈值设置了表示也就是说如果这个接口请求一共请求了次有次是慢的就达到了阈值最小请求数就是这次统计一次的意思统计时长设置就是每秒统计次如果这次中有请求超过了就说明它是慢调用比例分布式事务什么是分布式事务假设有个项目里面有订单服务购物车服务库存服务在单体项目中我们创建订单之后需要清理购物车然后还要扣减商品库存因为是在单体项目里面这三个业务都在一个事务中满足事务的原则但是在微服务项目中这三个业务分别在三个不同的服务中我们创建订单之后订单服务提交到订单服务的数据库然后调用购物车服务执行清理购物车操作此时操作的数据库是购物车服务的数据库不是订单服务的数据库然后调用库存服务执行扣减商品库存如果此时失败了是回滚不了的为什么回滚不了订单服务分别调用了购物车服务和库存服务库存服务发生了异常订单服务是可以回滚的因为订单服务和库存服务有关联但是购物车服务和库存服务是没有关联的所以购物车服务回滚不了不满足事务的原则在分布式系统中如果一个业务需要多个服务合作完成而且每一个服务都有事务多个事务必须同时成功或失败这样的事务就是分布式事务其中的每个服务的事务就是一个分支事务整个业务称为全局事务要想解决分布式事务问题我们可以使用什么是是阿里巴巴开源的分布式事务解决方案官网请点击中文官网地址方案思路如下图新增了一个事务协调者架构事务协调者维护全局和分支事务的状态协调全局事务提交或回滚事务管理器定义全局事务的范围负责全局事务的开启提交回滚资源管理器管理分支事务负责分支事务的注册提交回滚使用部署需要部署服务请自行查阅进行部署注意需要将服务注册到注册中心因为服务很重要有可能会集群部署而我们后续需要在各个微服务中配置服务地址如果是集群部署那么这个地址就不能配死服务部署之后我们还需要在微服务中集成在微服务中引入依赖在微服务中配置相关配置让微服务能找到服务地址注册中心的配置微服务根据这些信息去注册中心获取服务地址注册中心类型内部支持多种注册中心这里我们使用服务地址命名空间不填代表默认为服务在中的服务名用户名密码事务组名称就是注册中心的集群事务组与集群的映射关系对应上面事务组名称对应中的集群例子比如在订单服务用户服务和交易服务的配置文件中添加上面的配置或者将上面的配置配置到中作为共享配置然后在这三个服务中都引入上面的依赖注意如果是将上面的配置配置到中作为共享配置的话这里还要去这三个服务中的中将共享配置加上然后重启项目可以去查看服务的控制台看看这三个服务是否注册到服务中了集成好之后提供很多种模式比较常用的是模式和模式模式说明当执行到被注解标注的方法时开启全局事务然后每个微服务再执行语句之前先去注册分支事务再执行语句此时它不会立即提交数据库锁没有释放当全部微服务都将自己执行情况报告给之后如果都成功了就会通知每个微服务提交事务释放数据库锁如果其中一个微服务分支事务失败了就通知每个微服务都回滚事务总的来说模式有两阶段工作一阶段的工作注册分支事务到执行分支业务但不提交报告执行状态到二阶段的工作检测各分支事务执行状态如果都成功了通知所有提交事务如果有失败通知所有回滚事务接收指令提交或回滚事务这个模式的优点是事务的强一致性满足原则常用的数据库都支持实现简单并且没有代码侵入这个模式的缺点是因为一阶段需要锁定数据库资源等待二阶段结束才释放锁所以性能较差然后还依赖关系型数据库实现事务如果关系型数据不支持模式就不能实现怎么实现模式因为的已经完成了模式的自动装配实现非常简单步骤如下先在每个参与事务的微服务的配置文件中添加如下配置如果使用了共享配置的直接在中修改共享配置开启模式然后在需要开启全局事务的方法中添加注解创建订单调用本服务业务方法执行创建订单清理购物车调用购物车服务的业务方法执行清理购物车注意最好也在这个方法上添加注解扣减库存调用库存服务的业务方法执行扣减注意最好也在这个方法上添加注解模式是主推的默认模式说明当执行到被注解标注的方法时开启全局事务然后每个微服务再执行语句之前先去注册分支事务并且生成一份数据快照之后再执行并立刻提交当全部微服务都将自己执行情况报告给之后如果都成功了就会通知每个微服务删除之前生成的数据快照如果其中一个微服务分支事务失败了就通知每个微服务使用之前生成的备份数据快照恢复数据库回滚总的来说模式也有两阶段工作一阶段工作注册分支事务到备份数据快照再执行业务并立刻提交报告事务状态给二阶段工作如果都成功了通知删除备份的数据快照如果失败需要回滚通知根据备份的数据快照恢复数据到更新前实现模式的步骤需要先生成一个表用于存储数据快照的这张表在已分离的项目目录中也可以直接复制下面的语句都是一样的然后在每个参与事务的微服务的配置文件中添加如下配置如果使用了共享配置的直接在中修改共享配置开启模式最后在需要开启全局事务的方法中添加注解创建订单调用本服务业务方法执行创建订单清理购物车调用购物车服务的业务方法执行清理购物车注意最好也在这个方法上添加注解扣减库存调用库存服务的业务方法执行扣减注意最好也在这个方法上添加注解和的区别模式一阶段不提交事务锁定资源模式一阶段直接提交事务不锁定资源模式依赖数据库机制实现回滚模式利用数据快照实现数据回滚模式强一致性模式最终一致性消息队列的使用需求基于已分离的项目进行改造改造余额支付功能不再同步调用交易服务的接口而是采用异步通知交易服务更新订单状态说明交易服务只管发送消息到交换机其他服务要想获取消息就在自己服务声明创建交换机和队列去监听实现步骤因为目前项目中只有支付服务和交易服务所以这里只用这两个服务在支付服务发送者和交易服务消费者中引入依赖和配置依赖包含消息转换器序列化的部署地址的服务端口要使用的虚拟机连接到的用户名连接到的密码在支付服务发送者和交易服务消费者新建一个配置类配置消息转换器提示如果这个配置类写在公共包中的因为公共包是扫描不到的所以根据自动加载原理我们需要在公共包下的目录下的中将这个配置类的包路径配置进去在交易服务中新建包新建一个监听类在支付服务中的类中的方法中最后一行注释修改为发送消息注入在方法最后一行注释之后添加下面的代码第一个参数指定交换机名称第二个参数指定第三个参数发送的消息上面如果发送失败可能会影响原来的业务我们尽可能不要影响到原来的业务所以我们使用来捕获异常正确的该法是下面做一些日志输出重启两个服务处理消息重复投递问题场景消费者处理完消息后要返回状态给服务此时因为网络原因服务没有收到消费者的恢复服务就会将消息重新投递给消费者导致消费者重复处理消息处理方法在上面消息队列的使用的基础上基于业务判断方法来解决在服务第一次投递给消费者处理之前先查询数据库判断消息是否已经处理过如果处理过则直接返回不再处理修改交易服务的类新增查询订单新增判断订单状态是否为未支付表示未支付不做处理标记订单状态为已支付使用延迟消息插件上图解释用户下单请求到交易服务交易服务将订单保存到交易服务数据库然后远程调用商品服务扣减库存用户去支付请求到支付服务支付订单然后支付服务将消息发送给服务由服务通知交易服务更新订单状态此时因为某些原因支付服务不能通知交易服务解决办法使用延迟消息队列在交易服务保存订单之后向延迟消息队列发送延迟消息时间为分钟分钟之后延迟消息投递消息给交易服务由交易服务主动去远程查询支付服务判断订单是否支付成功如果支付成功更新订单状态如果支付失败或没有支付就取消订单并远程调用商品服务恢复库存注意做下面操作之前要确保已经在服务安装好延迟消息插件插件下面例子就不创建支付服务和交易服务之间的服务了因为以演示延迟消息队列为主下面例子在上面消息队列的使用的基础上进行在交易服务引入依赖在配置的相关配置以及配置消息转换器因为在上面消息队列的使用的基础上进行的已经配置过了具体查看上面消息队列的使用在交易服务创建常量类用来保存交换机队列名在交易服务类中的方法之前添加下面的代码发送延迟消息检测订单支付状态注意别忘了注入设置消息的延迟时间单位毫秒分钟在服务下新建下面三个类支付单的数据传输实体支付订单支付单数据传输实体业务订单号支付单号支付用户支付渠道编码支付金额单位分付类型小程序公众号扫码余额支付付状态待提交待支付支付超时或取消支付成功拓展字段用于传递不同渠道单独处理的字段第三方返回业务码第三方返回提示信息支付成功时间支付超时时间支付二维码链接创建时间更新时间支付系统的客户端根据交易订单查询支付单业务订单支付单信息支付系统的逻辑模块的中新增方法根据查询支付单在交易服务新建一个监听器创建包在包下创建一个类查询订单判断订单是否支付成功未付款订单不存在或者已经支付未支付需要远程查询支付流水状态判断是否支付已支付标记订单状态为已支付未支付取消订单回复库存启动服务测试如果启动报错需要去中的类上面使用表示有类的服务才让类生效抽取工具在企业开发中的常见应用我们就学习完毕了除了收发消息以外消息可靠性的处理生产者确认消费者确认延迟消息等等编码还是相对比较复杂的因此我们需要将这些常用的操作封装为工具方便在项目中使用要求如下将的配置抽取到中作为共享配置替换所有微服务中的自定义配置在模块下编写发送消息的工具类定义一个自动配置类内容包括声明一个交换机名为类型为声明一个队列名为微服务名也就是说要动态获取将队列与交换机绑定绑定时的就是微服务名声明消费失败消息投递到上述交换机给配置类添加条件当为时触发具体步骤抽取共享配置首先我们需要在中抽取的共享配置命名为其中只包含的基础共享配置内容如下主机名端口虚拟主机用户名密码引入依赖在模块引入要用到的一些依赖主要包括但是不要引入因为我们希望可以让用户按需引入依赖整合依赖处理注意依赖的要选择这样依赖仅仅是用作项目编译时不报错真正运行时需要使用者自行引入依赖封装工具在模块的包下新建一个类准备发送消息准备发送消息处理回执失败消息发送失败收到已重试次数消息发送重试次数耗尽发送失败自动装配最后我们在模块的包下定义一个配置类将注册为定义消息转换器配置自动创建消息用于识别不同消息因为是在公共包下的是扫描不到的所以为了让我们的配置生效我们需要在项目的下的文件中声明这个配置类至此的工具类和自动装配就完成了',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-12 13:31:05',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#e8dfc4')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/avatar/loading.gif"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">小Z成长录😀丶</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "city": "CN101290101",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/reward/zjyzanshang.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/zjyzanshang.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/reward/zjyzfb.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/zjyzfb.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Camunda/" style="font-size: 1.05rem;">Camunda<sup>1</sup></a><a href="/tags/ElasticSearch/" style="font-size: 1.05rem;">ElasticSearch<sup>1</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>1</sup></a><a href="/tags/IntelliJ-IDEA-2020-3-3-x64%E6%BF%80%E6%B4%BB%E6%96%B9%E6%B3%95/" style="font-size: 1.05rem;">IntelliJ IDEA 2020.3.3 x64激活方法<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>15</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/Maven/" style="font-size: 1.05rem;">Maven<sup>1</sup></a><a href="/tags/Mybatis/" style="font-size: 1.05rem;">Mybatis<sup>1</sup></a><a href="/tags/MybatisPlus/" style="font-size: 1.05rem;">MybatisPlus<sup>2</sup></a><a href="/tags/Mysql/" style="font-size: 1.05rem;">Mysql<sup>1</sup></a><a href="/tags/Postgresql/" style="font-size: 1.05rem;">Postgresql<sup>1</sup></a><a href="/tags/Postman/" style="font-size: 1.05rem;">Postman<sup>1</sup></a><a href="/tags/SVN/" style="font-size: 1.05rem;">SVN<sup>1</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>8</sup></a><a href="/tags/Vue/" style="font-size: 1.05rem;">Vue<sup>1</sup></a><a href="/tags/css/" style="font-size: 1.05rem;">css<sup>1</sup></a><a href="/tags/navicat/" style="font-size: 1.05rem;">navicat<sup>1</sup></a><a href="/tags/%E4%B9%A6%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 1.05rem;">书本知识<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 1.05rem;">前端<sup>3</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>28</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/" style="font-size: 1.05rem;">工作技能<sup>44</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/" style="font-size: 1.05rem;">工作流<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">数据库<sup>4</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 1.05rem;">服务器<sup>3</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">测试工具<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 1.05rem;">消息队列<sup>1</sup></a><a href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" style="font-size: 1.05rem;">版本控制<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">设计模式<sup>2</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/" itemprop="url">工作技能</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>工作技能</span></a><a class="article-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>后端</span></a><a class="article-meta__tags" href="/tags/Spring/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Spring</span></a></span></div></div><h1 class="post-title" itemprop="name headline">SpringCloud学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-11-27T02:00:57.000Z" title="发表于 2024-11-27 10:00:57">2024-11-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-01-12T05:31:05.771Z" title="更新于 2025-01-12 13:31:05">2025-01-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="SpringCloud学习笔记"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为昆明"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>昆明</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/page_background/cover_background_light.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://zc-zjy.github.io/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><header><a class="post-meta-categories" href="/categories/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/" itemprop="url">工作技能</a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/" tabindex="-1" itemprop="url">工作技能</a><a href="/tags/%E5%90%8E%E7%AB%AF/" tabindex="-1" itemprop="url">后端</a><a href="/tags/Spring/" tabindex="-1" itemprop="url">Spring</a><h1 id="CrawlerTitle" itemprop="name headline">SpringCloud学习笔记</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">十七</span><time itemprop="dateCreated datePublished" datetime="2024-11-27T02:00:57.000Z" title="发表于 2024-11-27 10:00:57">2024-11-27</time><time itemprop="dateCreated datePublished" datetime="2025-01-12T05:31:05.771Z" title="更新于 2025-01-12 13:31:05">2025-01-12</time></header><hr>
<h1 id="一、架构体系"><a href="#一、架构体系" class="headerlink" title="一、架构体系"></a>一、架构体系</h1><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1.png" class="">  
<p>1、说明<br>（1）注册中心（配置中心）、网关、各个服务启动，每个服务都会向注册中心注册，注册中心将每个服务的信息记录到它的数据库中，此时，每个服务和注册中心会建立心跳连接（相当于每隔一段时间，每个服务就会主动告诉注册中心，自己没有出现异常，没有挂掉），这样防止服务挂掉后，注册中心没有及时更新服务信息，导致调用方调用失败；<br>（2）网关启动之后，也会将自己注册到注册中心，然后从注册中心拉取每个服务的注册信息到内存中（这里可以使用动态路由，相关信息查看网关的动态路由设置）；<br>（3）前端发送请求，请求会先到网关，网关使用过滤器去校验请求，校验通过之后，会根据请求路径，从内存中找到相对应的服务，然后将请求转发给服务，服务在自己数据库进行crud业务处理之后返回结果。  </p>
<p>2、例子说明：<br>（1）用户在登录页进行登录，用户发送登录请求<code>/users/login</code>，这个请求在网关配置文件中配置的是白名单（白名单：不需要校验，可以直接通过的请求），该请求到达网关，网关不进行校验，直接从内存中匹配，匹配到是用户服务（登录校验还是在用户服务进行），因此将请求转发给用户服务；<br>（2）用户服务收到请求，进行登录校验，校验通过之后生成token返回给前端（先返回给网关，再返回给前端）；<br>（3）用户登录成功之后（注意：这里如果项目中登录打了断点，是成功不了的，这是因为网关降级），进行查找商品列表，发送<code>/items/list</code>请求；<br>（4）网关收到<code>/items/list</code>请求，因为该请求没有设置白名单，需要进行校验，校验token是否有效（无效返回401无效的token），校验通过之后，解析token为用户信息，然后从内存中匹配路由列表，匹配到的是商品服务，然后将用户信息重新设置到header请求头中，再将请求转发给商品服务；<br>（5）如果商品服务是集群，因为网关中设置了负载均衡，所以网关会根据负载均衡规则，将请求转发给商品服务集群中的某一个商品服务；<br>（6）商品服务接收到请求，会通过公共jar包中写好的拦截器设置好用户信息（这个拦截器不做别的事情，只获取header请求头中用户信息存入ThreadLocal供后面使用），再从数据库中查找商品列表，返回给网关，网关将商品列表返回给前端（如果商品服务中打了断点，也不会成功，因为网关降级）；<br>（7）用户查询购物车列表，查询购物车也要查询商品，这里就是服务之间的调用；<br>（8）用户查询购物车列表，发送请求<code>/carts/list</code>，网关收到请求，同样需要校验token并解析，校验通过之后，将解析出来的token（用户信息）重新设置到header请求头，转发给购物车服务；<br>（9）同样购物车服务收到请求，也会先执行公共jar包中写好的拦截器设置header请求头中的用户信息，然后购物车服务查询购物车列表，此时需要查找商品信息，因为商品信息在商品服务那，只能由商品服务来进行查询，所以购物车服务调用商品服务，本来这里可以使用restTemplate来发送请求给商品服务（因为都是基于http协议），但是这种做法比较麻烦，所以可以使用OpenFeign来简化这个过程，OpenFeign底层也是使用restTemplate，但是OpenFeign会根据接口定义，自动生成请求，然后发送给商品服务；<br>（10）购物车服务先通过OpenFeign提供好的接口，将用户信息设置到header请求头中，再发送请求给商品服务；<br>（11）商品服务接收到请求，同样先执行公共jar包中写好的拦截器获取用户信息，再进行商品的查询，然后返回给购物车服务；<br>（12）购物车服务接收到商品服务返回的商品列表，将商品列表返回给网关，网关将商品列表返回给前端。  </p>
<h1 id="二、SpringCloud组件"><a href="#二、SpringCloud组件" class="headerlink" title="二、SpringCloud组件"></a>二、SpringCloud组件</h1><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2.png" class="">  
<p>1、<code>注册中心</code>（服务注册发现）：Eureka（Netflix公司产品，被集成在SpringCloud中，一般用于Java应用）、Consul（HashCorp公司产品，被集成在SpringCloud中，不限制微服务语言）、Zookeeper、Nacos（Alibaba公司产品，被集成在SpringCloud中，用于Java应用）<br>2、<code>配置中心</code>（统一配置管理）：SpringCloud Config、Nacos<br>3、<code>负载均衡</code>：Ribbon、OpenFeign、Nacos<br>4、<code>网关</code>（统一网关路由）：Zuul、Gateway（SpringCloudGateway）<br>5、<code>服务调用</code>（服务远程调用）：OpenFeign、RestTemplate、Dubbo<br>6、<code>服务链路监控</code>：Zipkin、Sleuth<br>7、<code>流控、降级、保护</code>：Hystrix、Sentinel  </p>
<h1 id="三、单体演变为微服务过程"><a href="#三、单体演变为微服务过程" class="headerlink" title="三、单体演变为微服务过程"></a>三、单体演变为微服务过程</h1><p><a target="_blank" rel="noopener" href="https://b11et3un53m.feishu.cn/wiki/space/7229522334074372099?ccm_open_type=lark_wiki_spaceLink&open_tab_from=wiki_home">具体的文档教程请点击</a>。<br>本笔记中所用到的所有资料可在这里获取：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1jo-0f6Ge5p8B-_dK2dP0eg?pwd=78ly">链接</a><br>提取码：78ly<br>1、说明<br>将单体项目改为微服务项目。<br>（1）什么时候需要使用单体项目，什么时候使用微服务？<br><strong>创业型项目</strong>：先采用单体架构，快速开发，快速试错，随着规模扩大，逐渐拆分。<br><strong>确定的大型项目</strong>：资金充足，目标明确，可以直接选择微服务架构，避免后续拆分的麻烦。<br>（2）单体项目怎么拆分为微服务？<br><strong>高内聚</strong>：每个微服务的职责要尽量单一，包含的业务互相关联度高、完整度高。<br><strong>低耦合</strong>：每个微服务的功能要相对独立，尽量减少与其他微服务的依赖。<br>拆分方法一般有两种：<br><strong>纵向拆分</strong>：按照业务模块来拆分。<br><strong>横向拆分</strong>：抽取公共服务，提高复用性。<br>（3）有两种微服务结构：<br>第一种是<strong>独立Project</strong>，每个微服务都是一个独立的Project，每个Project都有自己的pom文件，每个Project都有自己的数据库，每个Project都有自己的启动类（相当于每个微服务都是一个项目，有几个微服务就有几个项目）。<br>第二种是<strong>聚合Project</strong>，每个微服务都是一个独立的Module，每个Module都有自己的pom文件，每个Module都有自己的数据库，但是这些Module共用一个启动类（相当于一个项目中有多个微服务模块，只有一个项目）。  </p>
<p>2、拆分过程<br>单体项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/zuo-junyuan/single-project">点击</a><br>前端地址：<a target="_blank" rel="noopener" href="https://gitee.com/zuo-junyuan/hmall-nginx">点击</a><br>已分离项目地址：<a target="_blank" rel="noopener" href="https://gitee.com/zuo-junyuan/microservice-learning-notes">点击</a><br>这里我们使用纵向拆分和第二种微服务结构，将用户、商品、购物车、订单、支付等模块拆分为五个不同的微服务。<br>这里只选商品服务进行演示，其他类似：<br>（1）在项目根目录创建一个module，起名为item-service；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/3.png" class="">  
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/4.png" class="">  
<p>（2）引入所需依赖和构建插件（从单体项目中进行拷贝）：<br>依赖：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--web--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--数据库--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--单元测试--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--redis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>构建插件（可以不用引入，从单体项目中拷贝）：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（3）分别创建启动类（启动类上面别忘了加mapper扫描注解、controller、pojo、service、mapper包；<br>（4）将单体项目中的三个yaml配置文件拷贝过来，并修改需要修改的配置；  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span> <span class="comment"># 这里需要修改</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">item-service</span> <span class="comment"># 这里需要修改</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">local</span> <span class="comment"># 这里需要修改</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 这里需要修改</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;hm.db.host&#125;:3306/hm-item?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.db.pw&#125;</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.hmall:</span> <span class="string">debug</span> <span class="comment"># 这里需要修改</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span></span><br><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">黑马商城商品服务接口文档</span> <span class="comment"># 这里需要修改</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;黑马商城商品服务接口文档&quot;</span> <span class="comment"># 这里需要修改</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">zhanghuyi@itcast.cn</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">虎哥</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">com.hmall.controller</span> <span class="comment"># 这里需要修改为你的controller包路径</span></span><br></pre></td></tr></table></figure>
<p>（5）将单体项目关于商品的pojo实体类、mapper、service、controller分别拷贝过来（按照这个顺序拷贝）；  </p>
<ul>
<li>pojo类：ItemDTO、OrderDetailDTO、Item、ItemPageQuery；  </li>
<li>mapper类：ItemMapper；  </li>
<li>service类：IItemService、ItemServiceImpl；<br>service实现类中需要修改<code>deductStock</code>方法中第一行<code>sqlStatement</code>值，修改为实际的路径。  </li>
<li>controller类：ItemController、SearchController。<br>这里解释controller类中的<code>@RequiredArgsConstructor</code>注解，这个注解是lombok提供的，用于自动生成一个包含所有final字段和带有@NonNull注解的字段的构造函数。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在这个示例中，Example 类使用了 <span class="doctag">@RequiredArgsConstructor</span> 注解，</span></span><br><span class="line"><span class="comment">	 * Lombok 会自动生成一个构造函数，该构造函数接受 id 和 name 两个参数，并初始化它们。</span></span><br><span class="line"><span class="comment">	 * description 字段不是 final，因此不会出现在生成的构造函数中。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Example</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Example</span>(<span class="number">1</span>, <span class="string">&quot;Example Name&quot;</span>);</span><br><span class="line">        System.out.println(example);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>（6）初始化数据库；<br>（7）启动商品服务测试，可以在下面图片中启动；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/5.png" class="">  
<p>要启动多个商品服务（集群）这样启动：  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/6.png" class="">  
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/7.png" class="">  
<p>（8）启动成功后，访问swagger接口文档<code>http://localhost:8081/doc.html</code>测试。<br>（9）在拆分购物车服务的时候，因为购物车服务需要查询商品信息，爆红的地方先不用管，将其注释，然后将service实现类中的<code>queryMyCarts</code>方法中第一行<code>UserContext.getUser()</code>注释掉，改为<code>1L</code>；<br>（10）现在我们来处理两个服务间如何调用，我们看之前单体项目，都是由前端发送http请求到后端，所以我们可以模仿单体项目发送请求的方式，使用<code>RestTemplate</code>来发送http请求，即在购物车服务使用<code>RestTemplate</code>发送http请求给商品服务；  </p>
<ul>
<li>在springboot配置类中注入<code>RestTemplate</code>，这里在启动类中注入，因为启动类也是配置类；  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;com.heima.cartservice.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartServiceApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(CartServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 声明RestTemplate为Bean</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在购物车服务的<code>CartServiceImpl</code>类中注入<code>RestTemplate</code>；  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入方式一：构造器注入，前提要在类上面使用<span class="doctag">@RequiredArgsConstructor</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入方式二：使用<span class="doctag">@Autowired</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br></pre></td></tr></table></figure></li>
<li>将<code>handleCartItems</code>方法中原来查询商品的代码注释掉，改为使用<code>RestTemplate</code>；  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 商品服务的接口地址为：http://localhost:8081/items?ids=1,2,3 形式</span></span><br><span class="line">ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; responseEntity = restTemplate.exchange(</span><br><span class="line">				<span class="comment">// 请求路径，也就是商品服务的接口地址</span></span><br><span class="line">                <span class="string">&quot;http://localhost:8081/items?ids=&#123;ids&#125;&quot;</span>,</span><br><span class="line">				<span class="comment">// 请求方式</span></span><br><span class="line">                HttpMethod.GET,</span><br><span class="line">				<span class="comment">// 请求参数</span></span><br><span class="line">                <span class="literal">null</span>, </span><br><span class="line">				<span class="comment">// 这里需要传字节码Clazz.class，因为这里我们需要传List类型，我们不可能传List.class，</span></span><br><span class="line">				<span class="comment">// 所以这里使用ParameterizedTypeReference来传List类型的字节码，它是泛型的引用</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() &#123;&#125;,</span><br><span class="line">				<span class="comment">// 这个参数是个map，下面的ids对应上面接口地址中的参数名</span></span><br><span class="line">				<span class="comment">// Map.of()是jdk11新增的方法，用于构建一个map</span></span><br><span class="line">				<span class="comment">// CollUtils.join(a, b)是hutool工具包中的方法，用于将a集合，以b分隔拼接成字符串</span></span><br><span class="line">                Map.of(<span class="string">&quot;ids&quot;</span>, CollUtils.join(itemIds, <span class="string">&quot;,&quot;</span>)));</span><br><span class="line"><span class="comment">// 进行判断，如果返回结果不为2xx，则直接返回</span></span><br><span class="line"><span class="keyword">if</span> (!responseEntity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">	<span class="comment">// 查询失败，直接返回</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">List&lt;ItemDTO&gt; items = responseEntity.getBody();</span><br><span class="line"><span class="comment">// 如果items为空，则直接返回</span></span><br><span class="line"><span class="keyword">if</span> (CollUtils.isEmpty(items)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>（11）重启购物车服务进行测试；<br>（12）因为我们在实际开发中不可能直接使用<code>restTemplate</code>发送<code>http://localhost:8081</code>这种请求，并且可能会涉及集群，上面方式不可行，因此我们使用nacos注册中心，通过服务名来访问服务；<br>（13）nacos服务自己百度或者官网，这里不再讲解；<br>（14）在每个服务中引入nacos依赖；  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- nacos这个包包含了服务的注册和发现了 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（15）在yml配置文件中配置nacos配置；  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">服务的名称，如商品服务就是：item-service</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">	  <span class="attr">server-addr:</span> <span class="string">nacos地址，默认为本地：127.0.0.1:8848，注意：这里不能配localhost，必须配数字！！！</span></span><br></pre></td></tr></table></figure>
<p>（16）重新启动服务，访问nacos管理平台<code>http://127.0.0.1:8848</code>，可以查看服务已经注册到nacos注册中心了；<br>（17）SpringCloud为了注册中心定义了一个标准，也就是一个接口<code>DiscoveryClient</code>，所有注册中心都实现了这个接口；<br>（18）我们在<code>CartServiceImpl</code>类中注入<code>DiscoveryClient</code>接口；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入方式一：构造器注入，前提要在类上面使用<span class="doctag">@RequiredArgsConstructor</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入方式二：使用<span class="doctag">@Autowired</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br></pre></td></tr></table></figure>
<p>（19）将之前的<code>restTemplate</code>相关代码全注释了，在查询商品信息那使用<code>discoveryClient</code>，改了之后重启测试；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据服务名获取nacos注册中心中的服务实例列表，这里实例名对应配置文件中配置的服务名，比如要调用商品服务就是item-service</span></span><br><span class="line">List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;item-service&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (CollUtil.isEmpty(instances)) &#123;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用随机负载均衡方式来从服务实例列表中获取一个服务</span></span><br><span class="line"><span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> instances.get(RandomUtil.randomInt(instances.size()));</span><br><span class="line"><span class="comment">// 发送请求</span></span><br><span class="line">ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; responseEntity = restTemplate.exchange(instance.getUri() + <span class="string">&quot;/items?ids=&#123;ids&#125;&quot;</span>,</span><br><span class="line">        HttpMethod.GET,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() &#123;</span><br><span class="line">        &#125;,</span><br><span class="line">        Map.of(<span class="string">&quot;ids&quot;</span>, CollUtils.join(itemIds, <span class="string">&quot;,&quot;</span>))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!responseEntity.getStatusCode().is2xxSuccessful()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">List&lt;ItemDTO&gt; items = responseEntity.getBody();</span><br><span class="line"><span class="comment">// 如果items为空，则直接返回</span></span><br><span class="line"><span class="keyword">if</span> (CollUtils.isEmpty(items)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（20）现在修改之后，还是太繁琐了，因为只要涉及到服务间的调用都要写一遍上面的代码，不可取，我们进行优化，改用<code>OpenFeign</code>方式来简化；<br><code>OpenFeign</code>是一个声明式的http客户端，是SpringCloud在Eureka公司开源的<code>Feign</code>基础上改造而来的，<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">官方地址</a>，其作用就是基于SpringMVC的常见注解，帮我们优雅的实现http请求的发送。<br>（21）引入<code>OpenFeign</code>和<code>OpenFeign</code>负载均衡依赖；  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 负载均衡 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（22）在启动类上添加<code>@EnableFeignClients</code>注解，开启<code>OpenFeign</code>；<br>（23）创建api包，并在api包下创建接口，接口上添加<code>@FeignClient</code>注解，并指定服务名，然后在接口中定义方法，方法上添加<code>@RequestMapping</code>注解，并指定请求路径（我们不用管这个方法的实现，它是通过动态代理来实现的）；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@FeignClient</span>(value = &quot;item-service&quot;)的意思是告诉OpenFeign，这个接口是调用item-service服务的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemApi</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 这里对应商品服务中的controller的接口</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/items&quot;)</span></span><br><span class="line">    List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(<span class="meta">@RequestParam(&quot;ids&quot;)</span> Collection&lt;Long&gt; ids)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（24）将上面关于<code>discoveryClient</code>的相关代码都注释，在<code>CartServiceImpl</code>类中注入<code>ItemApi</code>接口，并使用；<br>注入：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入方式一：构造器注入，前提要在类上面使用<span class="doctag">@RequiredArgsConstructor</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ItemApi itemApi;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入方式二：使用<span class="doctag">@Autowired</span>注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ItemApi itemApi;</span><br></pre></td></tr></table></figure>
<p>使用：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 直接调用接口中的方法查询商品信息即可</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;ItemDTO&gt; items = itemApi.queryItemByIds(itemIds);</span><br><span class="line"><span class="keyword">if</span> (CollUtils.isEmpty(items)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（25）因为<code>OpenFeign</code>发送请求是通过<code>Client</code>接口（专门发送http请求的接口）发的，这个接口默认实现是<code>HttpURLConnection</code>，这个jdk自带的，这个类发送请求，每次都要创建连接，利用Stream流的方式去作读写，效率比较低，我们需要优化，我们采用连接池的方式；<br><code>OpenFeign</code>对Http请求做了优雅的伪装，不过其底层发起http请求，依赖于其他的框架，这些框架可以自己选择，包括以下三种：  </p>
<ul>
<li><code>HttpURLConnection</code>：默认实现，不支持连接池；  </li>
<li><code>Apache HttpClient</code>：支持连接池；  </li>
<li><code>OKHttp</code>：支持连接池。<br>具体源码可以参考<code>FeignBlockingLoadBalancerClient</code>类中的<code>delegate</code>成员变量（开启连接池之后，可以查看该变量是否变成对应的连接池）。<br>这里选择<code>OKHttp</code>，<strong>注意</strong>：如果<code>Apache HttpClient</code>和<code>OKHttp</code>两个都使用，只会<code>HttpClient</code>生效。<br>（26）引入<code>OKHttp</code>依赖；  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- OKHttp --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
（27）在yaml配置文件中开启连接池的功能，重启之后查看<code>FeignBlockingLoadBalancerClient</code>类中的<code>delegate</code>成员变量是否变成对应的连接池；  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置okhttp</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
（28）假如有多个服务都需要查询商品服务的数据，那每个服务都要在自己服务中写一遍<code>ItemApi</code>接口，太繁琐，不可行，有两种解决方式；  </li>
<li>第一种：在A服务写AApi接口，也就是说由A服务自己提供，在A服务下建3个module，分别是dto、api、service，其中api就是用来给其他服务调用的，然后其他需要调用A服务的api，直接引用dto和api的依赖坐标即可；  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/8.png" class="">  </li>
<li>第二种：在总的项目下新建一个module，专门写各个服务的api，然后其他服务需要调用哪个api，直接引用这个module的依赖坐标即可。  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/9.png" class="">  
这里我们使用第二种。</li>
</ul>
<p>（29）在总的项目hmall下新建一个新的module，叫<code>api-service</code>；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/10.png" class="">  
<p>（30）在<code>api-service</code>的pom文件中引入关于<code>OpenFeign</code>相关的依赖；  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- OpenFeign --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 负载均衡 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- OKHttp --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.openfeign<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>feign-okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- common公共jar包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.heima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hm-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（31）在<code>api-service</code>中新建两个包dto和api，将原来的dto类和api接口移动到<code>api-service</code>的dto和api中（如果是复制粘贴，记得删除原来的dto和api）；<br>（32）将购物车服务的pom文件中引入<code>api-service</code>的依赖坐标；  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- api-service --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.heima<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>api-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（33）重启发现报错，是因为购物车服务中Springboot扫描器只能扫描到它自己规定的包路径，而<code>api-service</code>包中的类是扫描不到的，所以无法注入到Spring容器中，解决办法是：在购物车服务启动类上的<code>@EnableFeignClients</code>指定扫描<code>api-service</code>接口包路径，有两种指定方式；  </p>
<ul>
<li>第一种：指定FeignApi所在包路径，<code>@EnableFeignClients(basePackages = &quot;com.heima.apiservice.api&quot;)</code>；  </li>
<li>第二种：指定FeignApi字节码，<code>@EnableFegnClients(clients = &#123;ItemApi.class&#125;)</code>（可指定多个）。</li>
</ul>
<p>（34）<code>OpenFeign</code>日志输出配置；<br><code>OpenFeign</code>只会在<code>FeignApi</code>所在包的日志级别为<code>debug</code>，才会输出日志，而且其日志级别有4级：  </p>
<ul>
<li><code>none</code>：不记录任何日志信息，这个默认值；  </li>
<li><code>basic</code>：仅记录请求的方法、url以及响应状态码和执行时间；  </li>
<li><code>headers</code>：在<code>basic</code>的基础上，额外记录了请求和响应的头信息；  </li>
<li><code>full</code>：记录所有请求和响应的明细，包括头信息、请求体、元数据。<br>由于<code>Feign</code>默认的日志级别就是<code>none</code>，所以默认看不到请求日志。<br>我们查看yaml配置文件：  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.heima:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>
由上面yaml配置我们可以知道，不管是哪个服务，还是<code>api-service</code>module，只要包路径以<code>com.heima</code>开头，其日志级别都是<code>debug</code>，但是为什么还没日志输出，因为<code>OpenFeign</code>默认的日志级别为<code>none</code>（不输出任何信息），我们需要修改<code>OpenFeign</code>的日志级别。<br>在<code>api-service</code>module新建config包，新建<code>FeignLogConfig</code>配置类：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignLogConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这个配置类需要被Spring容器扫描到，有两种配置方式：<br>第一种配置方式（<code>局部配置</code>）：<br>在<code>api-service</code>的api某个接口中的<code>@FeignClient</code>注解中指定配置类：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;, configuration = FeignLogConfig.class)</span></span><br></pre></td></tr></table></figure>
第二种配置方式（<code>全局配置</code>）：<br>我们可以在<code>@EnableFegnClients</code>注解上指定包扫描路径：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置发送请求日志输出：</span></span><br><span class="line"><span class="comment"> * 1、首先在api-service module中创建日志配置类；</span></span><br><span class="line"><span class="comment"> * 2、在下面<span class="doctag">@EnableFeignClients</span>注解中将配置类配置进去即可。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.heima.apiservice.api&quot;, defaultConfiguration = &#123;FeignLogConfig.class&#125;)</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.heima.cartservice.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartServiceApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(CartServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>（35）拆分用户服务的时候，注意：<code>Address</code>类和login相关的都是属于用户服务，还需要<code>hmall.jks</code>（密钥文件）、<code>JwtProperties</code>类、<code>SecurityConfig</code>类、<code>JwtTool</code>工具类以及yaml配置文件中下面的配置：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">classpath:hmall.jks</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hmall123</span></span><br><span class="line">    <span class="attr">tokenTTL:</span> <span class="string">30m</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">excludePaths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/search/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/users/login</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/items/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/hi</span></span><br></pre></td></tr></table></figure>
<p><code>密钥文件</code>：生成jwt的密钥，可以看到打开是乱码，是因为被加密过了，密钥也需要加密的。<br><code>JwtProperties</code>：读取密钥文件的配置信息，里面的passwprd是<code>密钥文件</code>的密码，<code>密钥文件</code>本身是需要密码的。<br>（36）拆分交易服务时，牵扯到服务间的调用，需要在<code>api-service</code>编写api接口，可以去对应的controller中查看是否有需要的接口，如果有直接复制粘贴即可；<br>（37）拆分支付服务时，也有服务间的调用，测试就在支付服务的controller中将下面代码粘贴进去测试；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试用的</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;查询支付单&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;PayOrderVO&gt; <span class="title function_">getPayOrders</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BeanUtils.copyList(payOrderService.list(), PayOrderVO.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>（38）现在面临两个问题，问题一（现在后端有这么多服务，每个服务都有一个端口，前端如何调用？），问题二（服务间需要用到用户信息，即用户上下文<code>ThreadLocal</code>，这个服务间要怎么传递和获取？）；<br>（39）解决问题一，需要使用<code>网关</code>（查看最上面<code>一、架构体系</code>中的图）；<br><code>网关</code>：就是网络的关口，负责请求的路由、转发、身份校验。  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/11.png" class="">  
<p>（40）新建一个mudole网关服务<code>gateway-service</code>；  </p>
<ul>
<li>引入依赖；  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 网关服务依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 因为网关服务也需要注册到nacos注册中心，所以也需要nacos的依赖 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- nacos --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 因为网关在转发请求时也会用到负载均衡，所以也需要负载均衡的依赖 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 负载均衡 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>创建网关服务启动类  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayServiceApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayServiceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>新建yaml配置文件；  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span>  <span class="comment"># 这里其他服务实际上也需要配置的，默认配置是本地，所以其他服务没有配置</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment"># 路由属性</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart-service</span> <span class="comment"># 路由规则id，自定义，唯一就行</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span> <span class="comment"># 路由目标微服务，对应服务名称；lb表示负载均衡</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由断言，路由条件，满足条件时路由到目标微服务</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span> <span class="comment"># 路径匹配，以/carts开头的请求都路由到目标微服务，可以查看controller中的路径</span></span><br><span class="line">          <span class="comment"># filters:  过滤器，对请求或响应进行处理，每个服务接收请求之前的过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">item-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://item-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/items/**,</span> <span class="string">/search/**</span> <span class="comment"># 多个映射简化方式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">pay-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://pay-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/pay-orders/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">user-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://user-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/users/**,</span> <span class="string">/addresses/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">trade-service</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://trade-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/orders/**</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># default-filters: # 全局过滤器，对所有路由生效</span></span><br></pre></td></tr></table></figure>
配置文件中的<code>路由属性</code>：对应Java类型是<code>RouteDefinition</code>；<br>配置文件中的<code>路由断言</code>：Spring提供了12种基本的<code>RoutePredicateFactory</code>实现；  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/12.png" class="">  
配置文件中的<code>过滤器</code>：网关中已经提供好了33种路由过滤器，每种过滤器都具有独特的作用，具体可查看SpringCloud官网查看；<br>这33种过滤器使用方式，直接在配置文件中配置即可生效使用，例如：  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart-service</span> </span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span> </span><br><span class="line">          <span class="attr">predicates:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span> </span><br><span class="line">          <span class="attr">filters:</span>  <span class="string">配置单个过滤器</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">AddRequestHeader=test,</span> <span class="string">ceshi</span> <span class="string">test</span> <span class="comment"># 配置AddRequestHeader过滤器，作用是在当前请求中添加一个请求头，key是test，value是ceshi test</span></span><br></pre></td></tr></table></figure>
测试，在购物车服务controller的查询购物车列表接口中添加<code>@RequestHeader</code>注解获取请求头：  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;查询购物车列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CartVO&gt; <span class="title function_">queryMyCarts</span><span class="params">(<span class="meta">@RequestHeader(value = &quot;test&quot;, required = false)</span> String test)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;test = &quot;</span> + test);</span><br><span class="line">        <span class="keyword">return</span> cartService.queryMyCarts();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
访问：<code>http://localhost:8080/carts</code>，可以查看控制台输出信息；<br>上面这种使用方式针对的是某个服务进行配置，如果想配置全局过滤器，让所有服务都有该过滤器，可以这样配：  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cart-service</span> </span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cart-service</span> </span><br><span class="line">          <span class="attr">predicates:</span> </span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/carts/**</span> </span><br><span class="line">      <span class="attr">default-filters:</span> <span class="comment"># 全局过滤器配置</span></span><br><span class="line">	    <span class="bullet">-</span> <span class="string">AddRequestHeader=test,</span> <span class="string">ceshi</span> <span class="string">test</span></span><br><span class="line">			</span><br></pre></td></tr></table></figure></li>
</ul>
<p>（41）现在网关服务已经建好，需要做登录校验，先分析网关请求处理流程；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/13.png" class="">  
<p>说明：前端请求到达网关，网关中的<code>HandlerMapping</code>根据请求找到匹配的路由并存入上下文，然后再把请求交给<code>WebHandler</code>处理，<code>WebHandler</code>默认实现是<code>FilteringWebHandler</code>，它会加载我们在配置文件中配置的多个过滤器，放入到集合并排序，形成过滤器链，依次执行，这个过滤器先执行<code>pre</code>方法，然后最后一个过滤器<code>NettyRoutingFilter</code>将请求转发到微服务，微服务处理完后再返回到<code>NettyRoutingFilter</code>，再倒叙执行每个过滤器中的<code>post</code>方法。<br>根据上面的过程，我们要做登录校验，需要自定义一个过滤器去做校验，而且需要将用户信息（也就是解析的token）传给各个用户信息，这个自定义的过滤器还得做排序，必须在<code>NettRoutingFilter</code>这个过滤器之前执行，因为这个过滤器的作用就是负责将请求转发到各个微服务。<br>（42）自定义过滤器；  </p>
<ul>
<li><p><code>GatewayFilter</code>接口：局部单个过滤器，作用于配置文件中任意服务指定的路由，默认不生效，要配置到配置文件中的服务路由后才生效，就比如上面提到的33种过滤器就是网关为我们提供好的，都是基于这个接口实现的；<br>要想自定义一个单个局部过滤器，并不是直接去实现<code>GatewayFilter</code>接口，而是实现<code>AbstractGatewayFilterFactory</code>工厂接口，为什么要这样做？<br>因为局部单个过滤器需要在配置文件中指定：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span>  <span class="comment">#配置单个过滤器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">AddRequestHeader=test,</span> <span class="string">ceshi</span> <span class="string">test</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="attr">default-filters:</span> <span class="comment"># 全局过滤器配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">AddRequestHeader=test,</span> <span class="string">ceshi</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>
<p>它指定的格式是<code>过滤器名=参数，参数值</code>，可以发现<code>过滤器名</code>是固定的，但是<code>参数</code>有可能不同，所以我们需要用<code>过滤器工厂</code>根据参数去帮我们动态生成每一个过滤器。<br>这里还特别需要注意一点，就是给过滤器起名的时候，<strong>必须</strong>遵循<code>过滤器名</code>+<code>GatewayFilterFactory</code>后缀。<br><strong>无参过滤器</strong>：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 非全局无参过滤器，泛型里就是Object，哪个服务配置了这个过滤器，哪个服务接收请求之前才会执行，</span></span><br><span class="line"><span class="comment"> * 注意所有过滤器名字必须以‘xxx’ + ‘GatewayFilterFactory’格式来命名，然后配置里面就使用‘xxx’来配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoParameterGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Object config)</span> &#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 第一种：这里本来是要new GatewayFilter的，但是我们还需要排序，所以使用到了装饰类（装饰模式）；</span></span><br><span class="line"><span class="comment">		 * 第二种：也可以自己在下面new一个内部类，去分别实现GatewayFilter和Ordered接口，再在这里new</span></span><br><span class="line"><span class="comment">		 * 一般都会使用第一种方式</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedGatewayFilter</span>(<span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在配置文件中配置，注意要使用别忘了放开注解！  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span>  <span class="comment">#配置单个过滤器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">NoParameter</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="attr">default-filters:</span> <span class="comment"># 全局过滤器配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">NoParameter</span></span><br></pre></td></tr></table></figure>
<p><strong>有参过滤器</strong>：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractGatewayFilterFactory</span>&lt;ParameterGatewayFilterFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedGatewayFilter</span>(<span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">                <span class="comment">// 获取配置参数</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">parameOne</span> <span class="operator">=</span> config.getParameOne();</span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义配置属性，成员变量名称很重要，下面会用到</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">        <span class="comment">// 参数1</span></span><br><span class="line">        <span class="keyword">private</span> String parameOne;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数2</span></span><br><span class="line">        <span class="keyword">private</span> String parameTwo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数3</span></span><br><span class="line">        <span class="keyword">private</span> String parameThree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将变量名称依次返回，顺序很重，将来读取参数时需要按顺序获取</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">shortcutFieldOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> List.of(<span class="string">&quot;parameOne&quot;</span>, <span class="string">&quot;parameTwo&quot;</span>, <span class="string">&quot;parameThree&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Config字节码传递给父类，父类负责帮我们读取yml配置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParameterGatewayFilterFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据上面配置的顺序依次对应</span></span><br><span class="line"><span class="attr">filters:</span>  <span class="comment">#配置单个过滤器</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Parameter=&quot;对应parameOne&quot;,&quot;对应parameTwo&quot;,&quot;对应parameThree&quot;</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="attr">default-filters:</span> <span class="comment"># 全局过滤器配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Parameter=&quot;对应parameOne&quot;,&quot;对应parameTwo&quot;,&quot;对应parameThree&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>GlobalFilter</code>接口：全局过滤器，作用范围是所有路由，只要新建并且声明后自动生效，不需要在配置文件指定。<br>自定义一个类去实现<code>GlobalFilter</code>接口，注意，这里还需要实现另一个接口<code>Ordered</code>，这个接口是用来排序的：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局过滤器必须实现GlobalFilter接口，每个微服务接收请求之前都会执行，Ordered接口是为了排序，也必须实现</span></span><br><span class="line"><span class="comment"> * 要生效就把过滤器注入到容器，放开下面注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> &#123;Object&#125; ServerWebExchange exchange 请求上下文，包含整个过滤器链内共享数据，例如：request、response等</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> &#123;Object&#125; GatewayFilterChain chain 过滤器链，当前过滤器执行完后，要调用过滤器链中的下一个过滤器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 返回的值越小，优先级越高</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>（43）现在开始做网关登录校验；  </p>
<ul>
<li><p>需要将<code>hmall.jks</code>（密钥文件）、<code>JwtProperties</code>类、<code>AuthProperties</code>类（设置用户白名单的）、<code>SecurityConfig</code>类、<code>JwtTool</code>工具类以及下面配置文件中的配置复制粘贴过来；  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">classpath:hmall.jks</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hmall123</span></span><br><span class="line">    <span class="attr">tokenTTL:</span> <span class="string">30m</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="comment"># 这里设置的白名单，表示任何人都可以访问，对应AuthProperties类</span></span><br><span class="line">    <span class="attr">excludePaths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/search/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/users/login</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/items/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/hi</span></span><br></pre></td></tr></table></figure>
<p>需要注意<code>AuthProperties</code>类会报错，是因为Spring容器没有扫描到它，它不是一个Spring的管理Bean，可以只用<code>@Configuration</code>或者<code>@Component</code>注解将它注入Spring容器成为Bean。  </p>
</li>
<li><p>新建自定义登录校验过滤器；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthProperties authProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtTool jwtTool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取request</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 2. 判断是否需要做登录拦截</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isExclude(request.getPath().toString())) &#123;</span><br><span class="line">            <span class="comment">// 放行</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 获取token</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        List&lt;String&gt; authorizations = request.getHeaders().get(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (authorizations != <span class="literal">null</span> &amp;&amp; !authorizations.isEmpty()) &#123;</span><br><span class="line">            token = authorizations.get(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. 校验并解析token</span></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 解释下这里为什么要捕获异常</span></span><br><span class="line"><span class="comment">		 * 因为parseToken()方法如果出现异常会把异常抛出，这里我们不希望它将异常抛出，</span></span><br><span class="line"><span class="comment">		 * 我们希望设置一个状态码，让前端知道是因为没有权限，是因为解析token失败，</span></span><br><span class="line"><span class="comment">		 * 所以这里我们要捕获这个方法中出现的所有异常，然后重新设置响应码。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userId = jwtTool.parseToken(token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnauthorizedException e) &#123;</span><br><span class="line">            <span class="comment">// 拦截，设置响应状态码为401</span></span><br><span class="line">            <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5. 保存并传递用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> userId.toString();</span><br><span class="line">        <span class="type">ServerWebExchange</span> <span class="variable">swe</span> <span class="operator">=</span> exchange.mutate()</span><br><span class="line">                .request(builder -&gt; builder.header(<span class="string">&quot;user-info&quot;</span>, userInfo))</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 6. 放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(swe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExclude</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String pathPattern : authProperties.getExcludePaths()) &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 判断校验这里说明：</span></span><br><span class="line"><span class="comment">			 * 这里不能使用普通的字符串校验，因为这里的路径例如是&quot;/search/**&quot;格式，</span></span><br><span class="line"><span class="comment">			 * 如果使用字符串校验，那请求&quot;/searchlist/**&quot;这种也会被校验成功，不可行，</span></span><br><span class="line"><span class="comment">			 * 我们这里要用到特殊的校验路径的方式，spring给我们提供的校验工具AntPathMatcher</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(pathPattern, path)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>（44）现在我们已经完成了网关登录校验，但是还有一点需要做处理，就是网关登录校验成功之后，会把解析好的用户信息转发给其他服务，那这些微服务要怎么获取这个用户信息呢？所以我们需要自定义一个拦截器，专门获取用户信息，因为每个服务都会用到这个拦截器，所以我们在公共jar包中去新建；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在公共包中新建，因为能执行到这里，说明已经校验通过了，所以这个拦截器只做一件事：获取用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserInfoInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 获取登陆用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;user-info&quot;</span>);</span><br><span class="line">        <span class="comment">// 2. 判断是否获取了用户信息，如果有，存入ThreadLocal</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(userInfo)) &#123;</span><br><span class="line">            UserContext.setUser(Long.valueOf(userInfo));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 3. 清除ThreadLocal中的用户信息</span></span><br><span class="line">        UserContext.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义的拦截器需要添加到MVC配置中，再新建一个SpringMVC配置类，将这个拦截器配置进去；  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这里用到了<span class="doctag">@ConditionalOnClass</span>注解，需要说明：</span></span><br><span class="line"><span class="comment"> * 因为不止微服务用到了公共jar包，可能其他不需要使用到这个拦截器的jar包也使用到了公共jar包，</span></span><br><span class="line"><span class="comment"> * 以防万一，我们可以使用条件注解<span class="doctag">@ConditionalOnClass</span>，当类路径下存在DispatcherServlet类时，</span></span><br><span class="line"><span class="comment"> * 才会加载这个配置类，否则不加载，这样就不会影响其他jar包了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DispatcherServlet.class)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">UserInfoInterceptor</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现这个拦截器是在公共包中的，其他各个微服务是扫描不到的，所以根据Springboot自动配置原理，我们需要在<code>resources</code>包下的<code>META-INF/spring.factories</code>文件中配置这个拦截器：  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org<span class="selector-class">.springframework</span><span class="selector-class">.boot</span><span class="selector-class">.autoconfigure</span>.EnableAutoConfiguration=\</span><br><span class="line">  com<span class="selector-class">.hmall</span><span class="selector-class">.common</span><span class="selector-class">.config</span><span class="selector-class">.MyBatisConfig</span>,\</span><br><span class="line">  com<span class="selector-class">.hmall</span><span class="selector-class">.common</span><span class="selector-class">.config</span><span class="selector-class">.MvcConfig</span>,\</span><br><span class="line">  com<span class="selector-class">.hmall</span><span class="selector-class">.common</span><span class="selector-class">.config</span>.JsonConfig</span><br></pre></td></tr></table></figure>
<p>（45）服务间的调用，也需要传递解析token出来的用户信息，而服务间的调用是通过<code>OpenFeign</code>来调用的，我们需要用到<code>OpenFeign</code>中提供的拦截器<code>RequestInterceptor</code>接口（所有由<code>OpenFeign</code>发起的请求都会先调用这个拦截器处理请求）；<br>我们在<code>api-service</code>中的config包下，新建一个配置类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RequestInterceptor <span class="title function_">userInfoRequestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RequestInterceptor</span>() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 这个方法中的参数是requestTemplate，它提供header方法供我们修改请求头</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> requestTemplate</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">                <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserContext.getUser();</span><br><span class="line">                <span class="keyword">if</span> (userId != <span class="literal">null</span>) &#123;</span><br><span class="line">                    requestTemplate.header(<span class="string">&quot;user-info&quot;</span>, userId.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为这个<code>api-service</code>中的类是无法被Spring容器扫描到的，又因为它是个配置类，所以我们需要在每个使用了<code>OpenFeign</code>的服务的启动类上面的<code>@EnableFeignClients</code>注解中添加这个配置类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients(basePackages = &quot;com.heima.apiservice.api&quot;, defaultConfiguration = &#123;FeignLogConfig.class, FeignConfig.class&#125;)</span></span><br></pre></td></tr></table></figure>
<p>注意：记得将之前被注释的<code>UserContext.getUser()</code>改回来。<br>（46）现在来讲配置文件，如果需要将配置文件管理起来，可以使用<code>配置中心</code>，nacos自带了配置中心；<br>案例：我们继续上面的项目，现在将一些共享的配置添加到nacos配置中心去，包括：jdbc、MybatisPlus、日志、swagger、OpenFeign等配置。<br>访问：<code>localhost:8848</code>进入nacos后台管理系统，如果没有启动nacos就启动（目前启动的nacos是单机模式，启动命令：<code>startup.cmd -m standalone</code>）。<br>进入配置管理，新建三个配置文件：<code>shared-jdbc.yaml</code>、<code>shared-log.yaml</code>、<code>shared-swagger.yaml</code>，表单中的分组为默认<code>DEFAULT_GROUP</code>，描述自定义，格式为<code>yaml</code>，其他不用填，如下图所示；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/14.png" class="">  
<p><code>shared-jdbc.yaml</code>：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 这里读取项目配置文件中的hm.db.host属性，如果没有默认为127.0.0.1，其他同理</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;hm.db.host:127.0.0.1&#125;:$&#123;hm.db.port:3306&#125;/$&#123;hm.db.database&#125;?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.db.un:root&#125;</span> <span class="comment"># 这里读取项目配置文件中的hm.db.un属性，如果没有默认为root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.db.pw:root&#125;</span> <span class="comment"># 这里读取项目配置文件中的hm.db.pw属性，如果没有默认为root</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">default-enum-type-handler:</span> <span class="string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">update-strategy:</span> <span class="string">not_null</span></span><br><span class="line">      <span class="attr">id-type:</span> <span class="string">auto</span></span><br></pre></td></tr></table></figure>
<p><code>shared-log.yaml</code>：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.heima:</span> <span class="string">debug</span></span><br><span class="line">  <span class="attr">pattern:</span></span><br><span class="line">    <span class="attr">dateformat:</span> <span class="string">HH:mm:ss:SSS</span></span><br><span class="line">  <span class="attr">file:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>shared-swagger.yaml</code>：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">knife4j:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">openapi:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">$&#123;hm.swagger.title:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">$&#123;hm.swagger.des:黑马商城接口文档&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">zhanghuyi@itcast.cn</span></span><br><span class="line">    <span class="attr">concat:</span> <span class="string">虎哥</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://www.itcast.cn</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1.0.0</span></span><br><span class="line">    <span class="attr">group:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">group-name:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">api-rule:</span> <span class="string">package</span></span><br><span class="line">        <span class="attr">api-rule-resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">$&#123;hm.swagger.package&#125;</span> <span class="comment"># 如果没有设置默认值的，必须在项目配置文件中配置！</span></span><br></pre></td></tr></table></figure>
<p>然后将项目中原来的相对应的配置删除（也可以备份一份再删除），修改之后的配置文件内容如下：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置okhttp</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">okhttp:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">httpclient:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 下面配置对应配置中心的共享配置</span></span><br><span class="line"><span class="comment"># 配置数据库</span></span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">hm-cart</span></span><br><span class="line">  <span class="comment"># 配置swagger</span></span><br><span class="line">  <span class="attr">swagger:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">黑马商城购物车服务接口文档</span></span><br><span class="line">    <span class="attr">des:</span> <span class="string">黑马商城购物车服务接口文档</span></span><br><span class="line">    <span class="attr">package:</span> <span class="string">com.heima.cartservice.controller</span></span><br></pre></td></tr></table></figure>
<p>然后这里先讲下Springboot项目的启动流程，它是先加载<code>application.yaml</code>配置文件，然后再进行<code>ApplicationContext</code>的初始化。而现在我们用的是SpringCloud，它启动之后，会先拉取nacos配置中心的配置信息，然后进行SpringCloud的上下文初始化，才会进行Springboot的启动流程，但是它先拉取nacos配置中心，这个nacos配置中心的地址是在项目配置文件<code>application.yaml</code>中的，它不知道配置中心的地址怎么拉取呢？<br>我们可以引入依赖，然后在项目中新建一个配置文件<code>bootstrap.yaml</code>，将nacos配置中心的地址以及相关的信息配置进去，有了这个配置文件，SpringCloud启动之后，就会先读取这个配置文件，再拉取配置中心的配置。<br>依赖：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- nacos配置管理依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 读取bootstrap文件依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line">`bootstrap.yaml`：  </span><br><span class="line">``` yaml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cart-service # 对应下面（47）图片中的spring.application.name</span><br><span class="line">  profiles:</span><br><span class="line">    active: local # 对应下面（47）图片中的spring.active.profiles</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      server-addr: 127.0.0.1:8848 # nacos服务如果是本地，可以不配，默认已经是本地了</span><br><span class="line">      config:</span><br><span class="line">        file-extension: yaml # 配置nacos配置管理中的配置文件的后缀名，对应下面（47）图片中的file-extension</span><br><span class="line">        # 配置nacos配置管理中的配置文件</span><br><span class="line">        shared-configs:</span><br><span class="line">          - data-id: shared-jdbc.yaml</span><br><span class="line">          - data-id: shared-log.yaml</span><br><span class="line">          - data-id: shared-swagger.yaml</span><br></pre></td></tr></table></figure>
<p>（47）现在我们来将<code>配置热更新</code>（当修改配置文件中的配置时，微服务无需重启即可使配置生效）；<br>必要的条件有两个：<br>条件一：nacos中要有一个与微服务名有关的配置文件：  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/15.png" class="">  
<p><code>file-extension</code>项可以省略。<br>条件二：微服务中要以特定的方式读取需要热更新的配置属性：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取方式一</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;hm.cart&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer maxItems;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取方式二</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartProperties</span> &#123;</span><br><span class="line">	<span class="meta">@Value(&quot;$&#123;hm.cart.maxItems&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer maxItems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们修改项目，项目有个业务是购物车的限定数量是写死在代码中的，我们需要将它改为热更新。<br>我们先新建一个读取配置的类，就是上面条件二中的类，然后我们修改<code>CartServiceImpl</code>类的<code>checkCartsFull</code>方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CartProperties cartProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkCartsFull</span><span class="params">(Long userId)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> lambdaQuery().eq(Cart::getUserId, userId).count();</span><br><span class="line">    <span class="keyword">if</span> (count &gt;= cartProperties.getMaxItems()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BizIllegalException</span>(StrUtil.format(<span class="string">&quot;用户购物车课程不能超过&#123;&#125;&quot;</span>, cartProperties.getMaxItems()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们去配置中心新建一个配置<code>cart-service.yaml</code>（这里的起名要符合上面条件一中的要求）：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hm:</span> </span><br><span class="line">  <span class="attr">cart:</span> </span><br><span class="line">    <span class="attr">maxItems:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>（48）<code>动态路由配置</code>，现在微服务的配置都是写死在网关服务中的，那么要想实现动态路由配置该怎么办呢？<br>要实现<code>动态路由</code>，首先要将路由配置保存到nacos，当nacos中的路由配置变更时，推送最新的配置到网关服务，实时更新网关中的路由信息。<br>我们需要做两件事情：<code>监听nacos配置变更的消息</code>和<code>当配置变更时，将最新的路由信息更新到网关路由表</code>，这两件事情可以参考nacos官网<code>https://nacos.io</code>jdk中监听配置。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下面是官网提供的示例，这里是讲解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// nacos配置中心地址</span></span><br><span class="line"><span class="type">String</span> <span class="variable">serverAddr</span> <span class="operator">=</span> <span class="string">&quot;&#123;serverAddr&#125;&quot;</span>;</span><br><span class="line"><span class="comment">// 要加载的配置文件id</span></span><br><span class="line"><span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">&quot;&#123;dataId&#125;&quot;</span>;</span><br><span class="line"><span class="comment">// 要加载的配置文件group</span></span><br><span class="line"><span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> <span class="string">&quot;&#123;group&#125;&quot;</span>;</span><br><span class="line"><span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">properties.put(<span class="string">&quot;serverAddr&quot;</span>, serverAddr);</span><br><span class="line"><span class="comment">// 获取路由配置信息</span></span><br><span class="line"><span class="type">ConfigService</span> <span class="variable">configService</span> <span class="operator">=</span> NacosFactory.createConfigService(properties);</span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> configService.getConfig(dataId, group, <span class="number">5000</span>);</span><br><span class="line">System.out.println(content);</span><br><span class="line"><span class="comment">// 添加监听器</span></span><br><span class="line">configService.addListener(dataId, group, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;recieve1:&quot;</span> + configInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上面我们可以看到，它先要获取一次路由信息到内存，再进行监听</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>上面的示例太麻烦了，我们不用按照上面示例来，因为我们之前引入了<code>spring-cloud-starter-alibaba-nacos-config</code>nacos配置管理的依赖，它帮我们自动配置了，我们只需要使用它提供的<code>NacosConfigManager</code>接口即可。<br>我们先在网关服务中引入依赖：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- nacos配置管理依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 读取bootstrap文件依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后我们新建一个<code>bootstrap.yaml</code>配置文件：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">application:</span>  </span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway-service</span></span><br><span class="line">  <span class="attr">profiles:</span> </span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">nacos:</span> </span><br><span class="line">	  <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">	  <span class="attr">config:</span>  </span><br><span class="line">	    <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">		<span class="attr">shared-configs:</span> </span><br><span class="line">		  <span class="bullet">-</span> <span class="string">data-id</span> <span class="string">shared-log.yaml</span></span><br></pre></td></tr></table></figure>
<p>然后将网关服务原来的<code>application.yaml</code>配置文件修改为：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">hm:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">classpath:hmall.jks</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">hmall</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hmall123</span></span><br><span class="line">    <span class="attr">tokenTTL:</span> <span class="string">30m</span></span><br><span class="line">  <span class="attr">auth:</span></span><br><span class="line">    <span class="attr">excludePaths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/search/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/users/login</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/items/**</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/hi</span></span><br></pre></td></tr></table></figure>
<p>我们在网关服务新建一个包routers，然后新建一个类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicRouteLoader</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> NacosConfigManager nacosConfigManager;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RouteDefinitionWriter writer;</span><br><span class="line">	<span class="comment">// 对应配置中心中的配置文件名，这里为什么要json文件，因为json文件解析比较容易，yaml文件解析比较麻烦</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">&quot;gateway-routes.json&quot;</span>;</span><br><span class="line">	<span class="comment">// 对应配置中心的配置文件分组</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> <span class="string">&quot;DEFAULT_GROUP&quot;</span>;</span><br><span class="line">	<span class="comment">// 保存需要删除的routerIds，这里使用Set集合，因为Set集合不会重复</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; routerIds = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@PostConstruct</span> <span class="comment">// 在DynamicRouteLoader的bean初始化之后执行</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initRouteConfigListener</span><span class="params">()</span> <span class="keyword">throws</span> NacosException &#123;</span><br><span class="line">		<span class="comment">// 1. 项目启动时，先拉取一次配置，并且添加配置监听器</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">configInfo</span> <span class="operator">=</span> nacosConfigManager.getConfigService()</span><br><span class="line">						.getConfigAndSignListener(dataId, group,<span class="number">5000</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">							<span class="meta">@Override</span></span><br><span class="line">							<span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">								<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">							&#125;</span><br><span class="line">							</span><br><span class="line">							<span class="meta">@Override</span></span><br><span class="line">							<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">								<span class="comment">// 2. 监听到配置变更，需要去更新路由表</span></span><br><span class="line">								updateConfigInfo(configInfo);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;);</span><br><span class="line">		<span class="comment">// 3. 第一次读取到配置，也需要更新到路由表</span></span><br><span class="line">		updateConfigInfo(configInfo);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 更新路由表，监听到路由信息后，需要用到RouteDefinitionWriter接口类更新路由表</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * public interface RouteDefinitionWriter &#123;</span></span><br><span class="line"><span class="comment">	 *   </span></span><br><span class="line"><span class="comment">	 *   // 更新路由到路由表，如果路由id重复，则会覆盖旧的路由</span></span><br><span class="line"><span class="comment">	 *   Mono&lt;Void&gt; save(Mono&lt;RouteDefinition&gt; route);</span></span><br><span class="line"><span class="comment">	 *   </span></span><br><span class="line"><span class="comment">	 *   // 根据路由id删除路由表中的路由</span></span><br><span class="line"><span class="comment">	 *   Mono&lt;Void&gt; delete(Mono&lt;String&gt; routeId);</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * &#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">		<span class="comment">// 1. 解析配置信息，转为RouteDefinition</span></span><br><span class="line">		List&lt;RouteDefinition&gt; routeDefinitions = JSONUtil.toList(configInfo, RouteDefinition.class);</span><br><span class="line">		<span class="comment">// 2. 删除旧的路由表</span></span><br><span class="line">		<span class="keyword">for</span> (String routeId : routeIds) &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * delete方法需要用到Mono对象，这里Mono.just(routeId)表示将routeId包装成Mono对象</span></span><br><span class="line"><span class="comment">			 * .subscribe()表示执行删除方法，如果没有.subscribe()方法，是不会执行删除方法的</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			writer.delete(Mono.just(routeId)).subscribe();</span><br><span class="line">		&#125;</span><br><span class="line">		routeIds.clear();</span><br><span class="line">		<span class="comment">// 3. 添加新的路由表</span></span><br><span class="line">		<span class="keyword">for</span> (RouteDefinition routeDefinition : routeDefinitions) &#123;</span><br><span class="line">			writer.save(Mono.just(routeDefinition)).subscribe();</span><br><span class="line">			<span class="comment">// 4. 保存路由id，方便下次删除</span></span><br><span class="line">			routerIds.add(routeDefinition.getId());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启服务，因为现在网关服务中是没有任何其他微服务的地址信息的（路由信息），所以没办法做任何请求。<br>我们访问nacos配置中心管理后台，在配置管理中新建一个json文件<code>gateway-routes.json</code>（名字要与上面代码中的保持一致）：  </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">	<span class="punctuation">&#123;</span>    	<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;item&quot;</span><span class="punctuation">,</span>    	<span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://item-service&quot;</span><span class="punctuation">,</span>    	<span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span>    	    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Path&quot;</span><span class="punctuation">,</span>    	    <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>    	        <span class="attr">&quot;_genkey_0&quot;</span><span class="punctuation">:</span><span class="string">&quot;/items/**&quot;</span><span class="punctuation">,</span>    	         <span class="attr">&quot;_genkey_1&quot;</span><span class="punctuation">:</span><span class="string">&quot;/search/**&quot;</span>    	    <span class="punctuation">&#125;</span>    	<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span>    	<span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span>	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>按照上面的格式将其他服务信息也加进去，不用重启网关服务，直接查看项目控制台或者直接发送任何请求都可以（如果还是访问不了，需要等待一段时间，因为这个需要等待一会才能生效）。  </p>
<br/>


<hr>
<br/>



<h1 id="四、微服务架构体系"><a href="#四、微服务架构体系" class="headerlink" title="四、微服务架构体系"></a>四、微服务架构体系</h1><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/16.png" class="">  
<p>这个图就是微服务的架构体系图。<br>1、服务之间通过<code>OpenFeign</code>来互相调用；<br>2、各个微服务将自己信息注册到<code>Nacos</code>注册中心进行来进行服务治理；<br>3、前端发送请求给<code>Gateway</code>（网关），网关进行身份验证和请求路由转发；<br>4、可以通过<code>Nacos</code>来进行动态地配置管理。  </p>
<br/>


<hr>
<br/>



<h1 id="五、其他问题"><a href="#五、其他问题" class="headerlink" title="五、其他问题"></a>五、其他问题</h1><h3 id="1、雪崩问题"><a href="#1、雪崩问题" class="headerlink" title="1、雪崩问题"></a>1、雪崩问题</h3><p>1、什么是雪崩？<br>微服务调用链路中的某个服务故障，引起整个链路中的所有微服务都不可用。   </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/17.png" class="">  
<p>比如说，<code>商品服务</code>处理时间比较长（或者故障了），有个请求发送给网关，网关转发给<code>购物车服务</code>，<code>购物车服务</code>调用了<code>服务B</code>，这是正常的，然后又有请求转给<code>购物车服务</code>，<code>购物车服务</code>调用了<code>商品服务</code>（处理慢或者故障了），需要等很长时间，如果此时突然来了大量请求都需要<code>购物车服务</code>调用<code>商品服务</code>（高并发场景下），这些请求都需要等很长时间，而<code>tomcat</code>资源是有限的，这些有限的资源被这些请求占用着，后面再来请求处理别的就处理不了了，而其他需要调用<code>商品服务</code>的服务也会受到影响调用不了<code>商品服务</code>，整个微服务就受到影响。<br>（1）那为什么这个微服务的问题要叫雪崩呢？<br>因为这个微服务的问题和雪崩一样，雪崩是因为一点声音或者一片小雪花，就能产生雪崩。<br>（2）雪崩问题产生的原因是什么？<br>微服务互相调用，服务提供者出现故障或阻塞；<br>服务调用者没有做好异常处理，导致自身故障；<br>调用链中的所有服务级联失败，导致整个集群故障。<br>（3）解决问题的思路有哪些？<br>尽量避免服务出现故障或阻塞；<br>保证代码的健壮性；<br>保证网络畅通；<br>能应对较高的并发请求。  </p>
<p>2、解决雪崩问题的方案<br><strong>第一个方案：请求限流</strong>（属于服务保护方案）<br>请求限流：限制访问微服务的请求的并发量，避免服务因流量激增出现故障，如下图所示。  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/18.png" class="">  

<p><strong>第二个方案：线程隔离</strong>（属于服务保护方案）<br>线程隔离（舱壁模式）：模拟船舱隔板的防水原理，通过限定每个业务能使用的线程数量而将故障业务隔离，避免故障扩散。  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/19.png" class="">  

<p><strong>第三个方案：服务熔断</strong>（属于服务保护方案）<br>服务熔断：由断路器统计请求的异常比例或慢调用比例，如果超出阈值则会熔断该业务，则拦截该接口的请求。<br>背景由来：在使用线程隔离基础上，如下图：  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/20.png" class="">  
<p>假如<code>服务A</code>中有两个业务，分别需要调用<code>服务B</code>和<code>服务C</code>，我们将<code>服务A</code>中的业务分别设置线程数，<code>业务1</code>设置线程数为10，<code>业务2</code>设置线程数为4，当一个请求到<code>服务A</code>的<code>业务1</code>，它先领取一个线程，在去调用<code>服务B</code>，另一个请求到<code>服务A</code>的<code>业务2</code>，先领取线程再调用<code>服务C</code>，这就是线程隔离。<br>此时<code>服务C</code>故障了，来了四个请求都处理<code>服务A</code>的<code>业务2</code>，明知<code>服务C</code>故障，还要去调用<code>服务C</code>，就浪费资源了，所以这里需要<code>服务熔断</code>，当得知<code>服务C</code>故障了，就将其断开（之前遇到的在登录校验业务的地方打上断点或者在服务之间打上断点就请求不了的问题就是这个）。<br>然后这里熔断期间，所有请求快速失败，全部走<code>fallback</code>方法（在<code>服务A</code>提前写好），返回友好的提示，而不会等待<code>服务C</code>的响应，从而避免了故障的传播。  </p>
<p>3、服务保护技术  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/21.png" class="">  
<p>这里选用<code>Sentinel</code>来讲解。  </p>
<p>4、<code>Sentinel</code><br><code>Sentinel</code>是阿里巴巴开源的一款微服务流量控制组件，<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html">官网地址</a>。<br>（1）先从官网找到<code>启动 Sentinel 控制台</code>项，下载jar包并启动，启动命令官网中有。<br>（2）启动成功后，访问<code>http://localhost:8080</code>，可以看到<code>Sentinel</code>控制台界面。<br>（3）在<code>服务A</code>中引入<code>Sentinel</code>依赖：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 这个依赖中已经包含了官网中让引入的sentinel-transport-simple-http依赖 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（4）在<code>服务A</code>的<code>application.yml</code>中配置<code>Sentinel</code>：  </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span> </span><br><span class="line">	    <span class="attr">dashboard:</span> <span class="string">localhost:8090</span> <span class="comment"># 指定sentinel控制台地址</span></span><br></pre></td></tr></table></figure>
<p>（5）重启<code>服务A</code>，然后访问<code>服务A</code>的任意接口，<code>sentinel</code>控制台就会显示<code>服务A</code>接口的信息（注意这里得访问服务接口之后，控制台才会有信息）。  </p>
<p>5、介绍<code>Sentinel</code>控制台<br>（1）簇点链路（就是单机调用链路）<br>是一次请求进入服务后经过的每一个被Sentinel监控的资源链，默认Sentinel会监控SpringMVC的每一个http接口（即controller接口）。<br>因为默认监控的是controller接口，有时controller接口会采用restful风格，也就是说一个controller接口<code>/carts</code>可能存在请求方式不同（<code>get</code>、<code>post</code>、<code>delete</code>），所以我们需要设置用用请求方式来区分。  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">cloud:</span> </span><br><span class="line">    <span class="attr">sentinel:</span> </span><br><span class="line">	  <span class="attr">http-method-specify:</span> <span class="literal">true</span> <span class="comment"># 开启http请求方式区分</span></span><br></pre></td></tr></table></figure>
<p>我们查看我们的项目，购物车服务中的<code>/carts</code>接口，它里面调用了商品服务中的<code>/items</code>接口，假设<code>/carts</code>接口中还调用了<code>服务B</code>，然后商品服务的<code>/items</code>接口性能低或者宕机了，为了保护项目，我们需要设置<code>请求限流</code>、<code>线程隔离</code>和<code>服务熔断</code>。  </p>
<ul>
<li><p>在簇点链路中，设置<code>请求限流</code>：<br>在簇点链路中，我们选择<code>GET/carts</code>接口，在后面点击<code>流控</code>按钮，在弹出的窗口中不用去修改任何东西，只用修改那个阈值，这里介绍下<code>QPS</code>（每秒钟请求的数量），比如填了6，代表这个接口每秒钟只能请求6个。<br>测试可以使用<code>Jmeter</code>测试工具（这个测试工具和使用方法在已分离的项目git地址jmeter目录中）。  </p>
</li>
<li><p>在簇点链路中，设置<code>线程隔离</code>：<br>同<code>请求隔离</code>一样，也是点击<code>流控</code>按钮，这次我们选择阈值类型为<code>并发线程数</code>，例如<code>GET/carts</code>这个接口的<code>并发线程数</code>设置为5，<code>QPS</code>设置为6，说明这个接口每秒钟可以请求5*6&#x3D;30个请求，这样设置了之后，假如有大量请求去请求<code>GET/carts</code>接口，都不会影响购物车服务的其他接口性能；如果不设置，就会影响到购物车服务的其他接口性能。<br>这里我们还需要完善一点，就是如果大量请求都去请求<code>GET/carts</code>这个接口，虽然此时购物车服务的其它接口不会被影响，但是<code>GET/carts</code>这个接口的资源被占满之后就会直接报错，不是很友好，我们需要给<code>GET/carts</code>这个接口添加<code>fallback</code>方法，这样一来当<code>GET/carts</code>这个接口的请求超过30个时，就会触发<code>fallback</code>方法，返回友好提示，相当于就是只对<code>GET/carts</code>这个接口中调用商品服务接口这部分做<code>线程隔离</code>，不对整个<code>GET/carts</code>接口做<code>线程隔离</code>，但是我们发现在<code>Sentinel控制台</code>中，只有SpringMVC的请求接口是簇点链路，可以设置<code>线程隔离</code>，所以我们需要将<code>OpenFeign</code>接口也设置成簇点链路资源，让它可以设置<code>线程隔离</code>。<br>我们需要在购物车服务的配置文件中开启配置（<code>服务A</code>调用了<code>服务B</code>，就在<code>服务A</code>配置）：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span> </span><br><span class="line">  <span class="attr">sentinel:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启feign的sentinel支持</span></span><br></pre></td></tr></table></figure>
<p>因为我们需要写的商品服务的<code>fallback</code>方法，所以我们需要在<code>api-service</code>下新建ballback包，并新建一个类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现的方式有两种：</span></span><br><span class="line"><span class="comment"> * 1、实现FallbackClass接口，无法对远程调用的异常做处理；</span></span><br><span class="line"><span class="comment"> * 2、实现FallbackFactory接口，可以对远程调用的异常做处理，一般都选择这种方式。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 因为是针对ItemApi接口写的fallback方法，所以泛型中是ItemApi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ItemApiFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;ItemApi&gt; &#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> ItemApi <span class="title function_">create</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ItemApi</span>() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> List&lt;ItemDTO&gt; <span class="title function_">queryItemByIds</span><span class="params">(Collection&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">				<span class="comment">// 查询商品失败，返回空集合</span></span><br><span class="line">				<span class="keyword">return</span> CollUtils.emptyList();</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deductStock</span><span class="params">(List&lt;OrderDetailDTO&gt; items)</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(cause);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在配置类中，将<code>ItemApiFallbackFactory</code>类注册为bean：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ItemApiFallbackFactory <span class="title function_">itemApiFallbackFactory</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ItemApiFallbackFactory</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将<code>ItemApi</code>接口的<code>@FeignClient</code>注解中添加<code>fallbackFactory</code>属性，并指向<code>ItemApiFallbackFactory</code>类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;item-service&quot;, fallbackFactory = ItemApiFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ItemApi</span> &#123;</span><br><span class="line">	<span class="comment">// ...省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，当商品服务接口调用失败时，就会触发<code>fallback</code>方法，返回空集合，我们也可以去<code>Sentinel控制台</code>对<code>GET/carts</code>这个接口中调用商品服务接口这部分进行配置了。  </p>
</li>
<li><p>在簇点链路中，设置<code>服务熔断</code>：<br>思路是由<code>断路器</code>统计服务调用的异常比例、慢请求比例，如果超出阈值则会熔断该服务，即拦截访问该服务的一切请求，而当服务恢复时，<code>断路器</code>会放行访问该服务的请求。  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/22.png" class="">  
<p>上图说明：<br>（1）<code>断路器</code>有三种状态，分别是：<code>Closed</code>、<code>Open</code>、<code>Half-Open</code>；<br>（2）<code>断路器</code>默认状态是<code>Closed</code>，当服务调用失败比例超过阈值时，<code>断路器</code>会变成<code>Open</code>状态，此时所有请求都会被拦截，会执行<code>fallback</code>方法；<br>（3）当<code>断路器</code>变成<code>Open</code>状态后，经过一段时间，<code>断路器</code>会变成<code>Half-Open</code>状态，此时它会尝试放行一个请求，如果这个请求调用成功，则<code>断路器</code>会变成<code>Closed</code>状态，如果这个请求调用失败，则<code>断路器</code>会变成<code>Open</code>状态。<br>在簇点链路中，选择某个接口，点击<code>熔断</code>按钮，在弹出的窗口中，最大RT是最大响应时间，比如填了200ms，然后熔断策略选择了慢调用比例，代表如果请求这个接口超过了200ms，就说明这个接口是慢的，然后比例阈值设置了0.5，表示50%，也就是说如果这个接口请求一共请求了10次，有5次是慢的，就达到了阈值。最小请求数就是这10次，统计一次的意思。统计时长设置1000ms，就是每1秒统计10次，如果这10次中有50%请求超过了200ms，就说明它是慢调用比例。</p>
</li>
</ul>
<h3 id="2、分布式事务"><a href="#2、分布式事务" class="headerlink" title="2、分布式事务"></a>2、分布式事务</h3><p>1、什么是分布式事务？<br>假设有个项目，里面有<code>订单服务</code>、<code>购物车服务</code>、<code>库存服务</code>。<br>在单体项目中，我们创建订单之后，需要清理购物车，然后还要扣减商品库存，因为是在单体项目里面，这三个业务都在一个事务中，满足事务的ACID原则。<br>但是在微服务项目中，这三个业务分别在三个不同的服务中，我们创建订单之后，<code>订单服务</code>提交到<code>订单服务</code>的数据库，然后调用<code>购物车服务</code>，执行清理购物车操作，此时操作的数据库是<code>购物车服务</code>的数据库，不是<code>订单服务</code>的数据库，然后调用<code>库存服务</code>执行扣减商品库存，如果此时失败了，是回滚不了的（为什么回滚不了？<code>订单服务</code>分别调用了<code>购物车服务</code>和<code>库存服务</code>，<code>库存服务</code>发生了异常，<code>订单服务</code>是可以回滚的，因为<code>订单服务</code>和<code>库存服务</code>有关联，但是<code>购物车服务</code>和<code>库存服务</code>是没有关联的，所以<code>购物车服务</code>回滚不了），不满足事务的ACID原则。<br>在分布式系统中，如果一个业务需要多个服务合作完成，而且每一个服务都有事务，多个事务必须同时成功或失败，这样的事务就是<code>分布式事务</code>。其中的每个服务的事务就是一个<code>分支事务</code>，整个业务称为<code>全局事务</code>。<br>要想解决分布式事务问题，我们可以使用<code>Seata</code>。  </p>
<p>2、什么是Seata？<br>Seata是阿里巴巴开源的分布式事务解决方案，官网：<a target="_blank" rel="noopener" href="http://seata.io/">请点击</a>，<a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/">中文官网地址</a>。<br>方案思路如下图：新增了一个事务协调者。  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/23.png" class="">  

<p>3、Seata架构  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/24.png" class="">  
<p>（1）<code>TC</code>（Transaction Coordinator）：事务协调者，维护全局和分支事务的状态，协调全局事务提交或回滚。<br>（2）<code>TM</code>（Transaction Manager）：事务管理器，定义全局事务的范围，负责全局事务的开启、提交、回滚。<br>（3）<code>RM</code>（Resource Manager）：资源管理器，管理分支事务，负责分支事务的注册、提交、回滚。  </p>
<p>4、Seata使用<br>（1）Seata部署需要部署<code>TC</code>服务，请自行查阅进行部署，注意：需要将<code>TC</code>服务注册到注册中心（因为<code>TC</code>服务很重要，有可能会集群部署，而我们后续需要在各个微服务中配置<code>TC</code>服务地址，如果是集群部署，那么这个地址就不能配死）；<br>（2）<code>TC</code>服务部署之后，我们还需要在微服务中集成Seata，在微服务中引入依赖；  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（3）在微服务中配置seata相关配置，让微服务能找到<code>TC</code>服务地址：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span> </span><br><span class="line">  <span class="attr">registry:</span> <span class="comment"># 注册中心的配置，微服务根据这些信息去注册中心获取TC服务地址</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span> <span class="comment"># 注册中心类型，seata内部支持多种注册中心，这里我们使用nacos</span></span><br><span class="line">	<span class="attr">nacos:</span> </span><br><span class="line">	  <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment"># nacos服务地址</span></span><br><span class="line">	  <span class="attr">namespace:</span> <span class="string">&quot;&quot;</span> <span class="comment"># nacos命名空间，不填代表默认，为public</span></span><br><span class="line">	  <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">	  <span class="attr">application:</span> <span class="string">seata-server</span> <span class="comment"># TC服务在nacos中的服务名</span></span><br><span class="line">	  <span class="attr">username:</span> <span class="string">nacos</span> <span class="comment"># nacos用户名</span></span><br><span class="line">	  <span class="attr">password:</span> <span class="string">nacos</span> <span class="comment"># nacos密码</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">hmall</span> <span class="comment"># 事务组名称，就是nacos注册中心的集群</span></span><br><span class="line">  <span class="attr">service:</span> </span><br><span class="line">    <span class="attr">vgroup-mapping:</span> <span class="comment"># 事务组与TC集群的映射关系</span></span><br><span class="line">	  <span class="attr">hmall:</span> <span class="string">&quot;default&quot;</span> <span class="comment"># key:value，key对应上面事务组名称，value对应nacos中的集群</span></span><br></pre></td></tr></table></figure>
<p>例子：<br>比如在订单服务、用户服务和交易服务的配置文件中添加上面的配置（或者将上面的配置配置到nacos中作为共享配置），然后在这三个服务中都引入上面的依赖，注意：如果是将上面的配置配置到nacos中作为共享配置的话，这里还要去这三个服务中的bootstrap.yaml中将共享配置加上！<br>然后重启项目，可以去查看<code>TC</code>服务的控制台，看看这三个服务是否注册到<code>TC</code>服务中了。  </p>
<p>（4）集成好之后，seata提供很多种模式，比较常用的是<code>XA</code>模式和<code>AT</code>模式；<br>（5）<code>XA</code>模式；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/25.png" class="">  
<p>说明：当执行到被<code>@GlobalTransactional</code>注解标注的方法时，开启全局事务，然后每个微服务再执行sql语句之前，先去<code>TC</code>注册分支事务，再执行sql语句，此时它不会立即提交（数据库锁没有释放），当全部微服务都将自己sql执行情况报告给<code>TC</code>之后，如果都成功了，<code>TC</code>就会通知每个微服务提交事务（释放数据库锁），如果其中一个微服务分支事务失败了，就通知每个微服务都回滚事务。<br>总的来说，<code>XA</code>模式有两阶段工作：<br>一阶段的工作：<code>RM</code>注册分支事务到<code>TC</code>，<code>RM</code>执行分支业务sql但不提交，<code>RM</code>报告执行状态到<code>TC</code>；<br>二阶段的工作：<code>TC</code>检测各分支事务执行状态（如果都成功了，通知所有<code>RM</code>提交事务；如果有失败，通知所有<code>RM</code>回滚事务），<code>RM</code>接收<code>TC</code>指令，提交或回滚事务。<br>这个模式的优点是：事务的强一致性，满足ACID原则，常用的数据库都支持，实现简单，并且没有代码侵入。<br>这个模式的缺点是：因为一阶段需要锁定数据库资源，等待二阶段结束才释放锁，所以性能较差，然后还依赖关系型数据库实现事务（如果关系型数据不支持<code>XA</code>模式就不能实现）。<br>怎么实现<code>XA</code>模式？因为seata的starter已经完成了XA模式的自动装配，实现非常简单，步骤如下：<br>先在每个参与事务的微服务的配置文件中，添加如下配置（如果使用了共享配置的，直接在nacos中修改共享配置）：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span> </span><br><span class="line">  <span class="attr">data-source-proxy-mode:</span> <span class="string">XA</span> <span class="comment"># 开启XA模式</span></span><br></pre></td></tr></table></figure>
<p>然后在需要开启全局事务的方法中添加<code>@GlobalTransactional</code>注解：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">createOrder</span><span class="params">(OrderFormDTO order)</span> &#123;</span><br><span class="line">	<span class="comment">// 创建订单.....调用本服务业务方法执行创建订单sql</span></span><br><span class="line">	<span class="comment">// 清理购物车.....调用购物车服务的业务方法执行清理购物车sql，注意：最好也在这个方法上添加@Transactional注解</span></span><br><span class="line">	<span class="comment">// 扣减库存.....调用库存服务的业务方法执行扣减sql，注意：最好也在这个方法上添加@Transactional注解</span></span><br><span class="line">	<span class="keyword">return</span> order.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（6）<code>AT</code>模式（是seata主推的默认模式）；  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/26.png" class="">  
<p>说明：当执行到被<code>@GlobalTransactional</code>注解标注的方法时，开启全局事务，然后每个微服务再执行sql语句之前，先去<code>TC</code>注册分支事务，并且生成一份sql数据快照，之后再执行sql并立刻提交，当全部微服务都将自己sql执行情况报告给<code>TC</code>之后，如果都成功了，<code>TC</code>就会通知每个微服务删除之前生成的sql数据快照，如果其中一个微服务分支事务失败了，就通知每个微服务使用之前生成的备份数据快照恢复数据库（回滚）。<br>总的来说，<code>AT</code>模式也有两阶段工作：<br>一阶段工作：<code>RM</code>注册分支事务到<code>TC</code>，<code>RM</code>备份数据快照再执行业务sql并立刻提交，<code>RM</code>报告事务状态给<code>TC</code>；<br>二阶段工作：如果都成功了，<code>TC</code>通知<code>RM</code>删除备份的数据快照，如果失败需要回滚，<code>TC</code>通知<code>RM</code>根据备份的数据快照恢复数据到更新前。<br>实现<code>AT</code>模式的步骤：<br>需要先生成一个<code>undo_log</code>表，用于存储sql数据快照的（这张表在已分离的项目seata目录中seata-at.sql，也可以直接复制下面的sql语句，都是一样的）：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `undo_log`</span><br><span class="line">(</span><br><span class="line">    `branch_id`     <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;branch transaction id&#x27;</span>,</span><br><span class="line">    `xid`           <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;global transaction id&#x27;</span>,</span><br><span class="line">    `context`       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;undo_log context,such as serialization&#x27;</span>,</span><br><span class="line">    `rollback_info` LONGBLOB     <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;rollback info&#x27;</span>,</span><br><span class="line">    `log_status`    <span class="type">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;0:normal status,1:defense status&#x27;</span>,</span><br><span class="line">    `log_created`   DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;create datetime&#x27;</span>,</span><br><span class="line">    `log_modified`  DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;modify datetime&#x27;</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`, `branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4 COMMENT <span class="operator">=</span><span class="string">&#x27;AT transaction mode undo table&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>然后在每个参与事务的微服务的配置文件中，添加如下配置（如果使用了共享配置的，直接在nacos中修改共享配置）：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span> </span><br><span class="line">  <span class="attr">data-source-proxy-mode:</span> <span class="string">AT</span> <span class="comment"># 开启AT模式</span></span><br></pre></td></tr></table></figure>
<p>最后在需要开启全局事务的方法中添加<code>@GlobalTransactional</code>注解：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">createOrder</span><span class="params">(OrderFormDTO order)</span> &#123;</span><br><span class="line">	<span class="comment">// 创建订单.....调用本服务业务方法执行创建订单sql</span></span><br><span class="line">	<span class="comment">// 清理购物车.....调用购物车服务的业务方法执行清理购物车sql，注意：最好也在这个方法上添加@Transactional注解</span></span><br><span class="line">	<span class="comment">// 扣减库存.....调用库存服务的业务方法执行扣减sql，注意：最好也在这个方法上添加@Transactional注解</span></span><br><span class="line">	<span class="keyword">return</span> order.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（7）<code>AT</code>和<code>XA</code>的区别；  </p>
<ul>
<li><code>XA</code>模式一阶段不提交事务，锁定资源，<code>AT</code>模式一阶段直接提交事务，不锁定资源；  </li>
<li><code>XA</code>模式依赖数据库机制实现回滚，<code>AT</code>模式利用数据快照实现数据回滚；  </li>
<li><code>XA</code>模式强一致性，<code>AT</code>模式最终一致性。</li>
</ul>
<p><a id="spring-cloud-53"></a></p>
<h3 id="3、消息队列的使用"><a href="#3、消息队列的使用" class="headerlink" title="3、消息队列的使用"></a>3、消息队列的使用</h3><p>1、需求：基于已分离的项目进行改造，改造余额支付功能，不再同步调用交易服务的OpenFeign接口，而是采用异步MQ通知交易服务更新订单状态。  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/27.png" class="">  
<p>说明：<code>交易服务</code>只管发送消息到<code>交换机</code>，其他服务要想获取消息，就在自己服务声明创建<code>交换机</code>和<code>队列</code>去监听。  </p>
<p>2、实现步骤<br>因为目前项目中只有<code>支付服务</code>和<code>交易服务</code>，所以这里只用这两个服务。<br>（1）在<code>支付服务</code>（发送者）和<code>交易服务</code>（消费者）中引入依赖和配置yaml：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 消息转换器序列化 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">rabbitmq:</span> </span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="comment"># RabbitMQ的部署ip地址</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># RabbitMQ的服务端口</span></span><br><span class="line">	<span class="attr">virtual-host:</span> <span class="string">/mq</span> <span class="comment"># 要使用的虚拟机</span></span><br><span class="line">	<span class="attr">username:</span> <span class="string">admin</span> <span class="comment"># 连接到RabbitMQ的用户名</span></span><br><span class="line">	<span class="attr">password:</span> <span class="string">admin</span> <span class="comment"># 连接到RabbitMQ的密码</span></span><br></pre></td></tr></table></figure>
<p>（2）在<code>支付服务</code>（发送者）和<code>交易服务</code>（消费者）新建一个配置类，配置消息转换器：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提示：如果这个配置类写在common公共包中的，因为公共包Springboot是扫描不到的，所以根据Springboot自动加载原理，我们需要在公共包下的resources目录下的<code>META-INF/spring.factories</code>中将这个配置类的包路径配置进去。<br>（3）在<code>交易服务</code>中新建listener包，新建一个监听类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayStatusListener</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderService orderService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">	  value = @Queue(name = &quot;trade.pay.success.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">	  exchange = @Exchange(name = &quot;pay.direct&quot;),</span></span><br><span class="line"><span class="meta">	  key = &quot;pay.success&quot;</span></span><br><span class="line"><span class="meta">	))</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenPaySuccess</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">		orderService.updateOrderStatus(orderId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）在<code>支付服务</code>中的<code>PayOrderServiceImpl</code>类中的<code>tryPayOrderByBalance</code>方法中最后一行注释，修改为发送消息：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入RabbitTemplate</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在tryPayOrderByBalance方法最后一行注释之后，添加下面的代码</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 第一个参数：指定交换机名称</span></span><br><span class="line"><span class="comment"> * 第二个参数：指定RoutingKey</span></span><br><span class="line"><span class="comment"> * 第三个参数：发送的消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">&quot;pay.direct&quot;</span>, <span class="string">&quot;pay.success&quot;</span>, po.getBizOrderNo());</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上面如果发送失败可能会影响原来的业务，</span></span><br><span class="line"><span class="comment"> * 我们尽可能不要影响到原来的业务，所以我们使用try-catch来捕获异常，</span></span><br><span class="line"><span class="comment"> * 正确的该法是下面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	rabbitTemplate.convertAndSend(<span class="string">&quot;pay.direct&quot;</span>, <span class="string">&quot;pay.success&quot;</span>, po.getBizOrderNo());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	<span class="comment">// 做一些日志输出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启两个服务。  </p>
<p><a id="spring-cloud-54"></a></p>
<h3 id="4、处理MQ消息重复投递问题"><a href="#4、处理MQ消息重复投递问题" class="headerlink" title="4、处理MQ消息重复投递问题"></a>4、处理MQ消息重复投递问题</h3><p>1、场景<br>消费者处理完消息后，要返回状态给MQ服务，此时因为网络原因，MQ服务没有收到消费者的恢复，MQ服务就会将消息重新投递给消费者，导致消费者重复处理消息。<br>2、处理方法<br>在上面<code>3、消息队列的使用</code>的基础上<code>基于业务判断</code>方法来解决。<br>在MQ服务第一次投递给消费者处理之前，先查询数据库，判断消息是否已经处理过，如果处理过则直接返回ACK，不再处理。<br>修改<code>交易服务</code>的PayStatusListener类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayStatusListener</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderService orderService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">	  value = @Queue(name = &quot;trade.pay.success.queue&quot;, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">	  exchange = @Exchange(name = &quot;pay.direct&quot;),</span></span><br><span class="line"><span class="meta">	  key = &quot;pay.success&quot;</span></span><br><span class="line"><span class="meta">	))</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenPaySuccess</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">		<span class="comment">// 1、新增查询订单</span></span><br><span class="line">		<span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">		<span class="comment">// 2、新增判断订单状态，是否为未支付，1表示未支付</span></span><br><span class="line">		<span class="keyword">if</span> (order == <span class="literal">null</span> || order.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="comment">// 不做处理</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 标记订单状态为已支付</span></span><br><span class="line">		orderService.updateOrderStatus(orderId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><a id="spring-cloud-55"></a></p>
<h3 id="5、使用延迟消息插件"><a href="#5、使用延迟消息插件" class="headerlink" title="5、使用延迟消息插件"></a>5、使用延迟消息插件</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/28.png" class="">  
<p>上图解释：<br>（1）用户下单，请求到交易服务，交易服务将订单保存到交易服务数据库，然后远程调用商品服务，扣减库存；<br>（2）用户去支付，请求到支付服务，支付订单，然后支付服务将消息发送给MQ服务，由MQ服务通知交易服务更新订单状态；<br>（3）此时因为某些原因，支付服务不能通知交易服务；<br>（4）解决办法使用延迟消息队列，在交易服务保存订单之后，向延迟消息队列发送延迟消息，时间为15分钟；<br>（5）15分钟之后，延迟消息投递消息给交易服务，由交易服务主动去远程查询支付服务，判断订单是否支付成功；<br>（6）如果支付成功，更新订单状态；<br>（7）如果支付失败或没有支付，就取消订单，并远程调用商品服务，恢复库存。<br>注意：<br>（1）做下面操作之前，要确保已经在MQ服务安装好延迟消息插件（DelayExchange插件）；<br>（2）下面例子就不创建支付服务和交易服务之间的MQ服务了，因为以演示延迟消息队列为主；<br>（3）下面例子在上面<code>3、消息队列的使用</code>的基础上进行。<br>1、在交易服务引入依赖，在yaml配置MQ的相关配置以及配置消息转换器，因为在上面<code>3、消息队列的使用</code>的基础上进行的，已经配置过了，具体查看上面<a href="#spring-cloud-53">3、消息队列的使用</a>。<br>2、在交易服务创建常量类，用来保存交换机、队列名：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConstant</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.direct&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;trade.delay.order.queue&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_ORFRT_KEY</span> <span class="operator">=</span> <span class="string">&quot;delay.order.query&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、在交易服务<code>OrderServiceImpl</code>类中的<code>createOrder</code>方法return之前添加下面的代码：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送延迟消息，检测订单支付状态</span></span><br><span class="line"><span class="comment">// 注意别忘了注入RabbitTemplate</span></span><br><span class="line">rabbitTemplate.convertAndSend(</span><br><span class="line">  RabbitMQConstant.DELAY_EXCHANGE_NAME,</span><br><span class="line">  RabbitMQConstant.DELAY_ORFRT_KEY,</span><br><span class="line">  order.getId(),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">  	<span class="meta">@Override</span></span><br><span class="line">  	<span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">  		<span class="comment">// 设置消息的延迟时间，单位毫秒，15分钟</span></span><br><span class="line">  		message.getMessageProperties().setDelay(<span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">  		<span class="keyword">return</span> message;</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>4、在<code>hm-api</code>服务下新建下面三个类：<br>PayOrderDTO：支付单的数据传输实体。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 支付订单</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = &quot;支付单数据传输实体&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayOrderDTO</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;业务订单号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bizOrderNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付单号&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long payOrderNo;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付用户id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long bizUserId;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付渠道编码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String payChannelCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付金额，单位分&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer amount;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;付类型，1：h5,2:小程序，3：公众号，4：扫码，5：余额支付&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer payType;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;付状态，0：待提交，1:待支付，2：支付超时或取消，3：支付成功&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;拓展字段，用于传递不同渠道单独处理的字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String expandJson;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;第三方返回业务码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String resultCode;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;第三方返回提示信息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String resultMsg;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付成功时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime paySuccessTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付超时时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime payOverTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;支付二维码链接&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String qrCodeUrl;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;创建时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;更新时间&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PayClient：支付系统的Feign客户端。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;pay-service&quot;, fallbackFactory = PayClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PayClient</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据交易订单id查询支付单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 业务订单id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 支付单信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/pay-orders/biz/&#123;id&#125;&quot;)</span></span><br><span class="line">    PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PayClientFallback：支付系统的fallback逻辑。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayClientFallback</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;PayClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PayClient <span class="title function_">create</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PayClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、<code>pay-service</code>模块的PayController中新增方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;根据id查询支付单&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/biz/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PayOrderDTO <span class="title function_">queryPayOrderByBizOrderNo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">    <span class="type">PayOrder</span> <span class="variable">payOrder</span> <span class="operator">=</span> payOrderService.lambdaQuery().eq(PayOrder::getBizOrderNo, id).one();</span><br><span class="line">    <span class="keyword">return</span> BeanUtils.copyBean(payOrder, PayOrderDTO.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6、在交易服务新建一个监听器，创建listen包，在包下创建一个类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayMessageListener</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> IOrderService orderService;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">	  value = @Queue(name = RabbitMQConstant.DELAY_QUEUE_NAME, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">	  exchange = @Exchange(name = RabbitMQConstant.DELAY_EXCHANGE_NAME, delayed = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">	  key = RabbitMQConstant.DELAY_ORFRT_KEY</span></span><br><span class="line"><span class="meta">	))</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listenDelayMessage</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">		<span class="comment">// 1、查询订单</span></span><br><span class="line">		<span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.getById(orderId);</span><br><span class="line">		<span class="comment">// 2、判断订单是否支付成功，1：未付款</span></span><br><span class="line">		<span class="keyword">if</span> (order == <span class="literal">null</span> || order.getStatus() != <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="comment">// 订单不存在或者已经支付</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 3.未支付，需要远程查询支付流水状态</span></span><br><span class="line">		<span class="type">PayOrderDTO</span> <span class="variable">payOrder</span> <span class="operator">=</span> payClient.queryPayOrderByBizOrderNo(orderId);</span><br><span class="line">		<span class="comment">// 4.判断是否支付</span></span><br><span class="line">		<span class="keyword">if</span>(payOrder != <span class="literal">null</span> &amp;&amp; payOrder.getStatus() == <span class="number">3</span>)&#123;</span><br><span class="line">		    <span class="comment">// 4.1.已支付，标记订单状态为已支付</span></span><br><span class="line">		    orderService.markOrderPaySuccess(orderId);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		    <span class="comment">// TODO 4.2.未支付，取消订单，回复库存</span></span><br><span class="line">		    orderService.cancelOrder(orderId);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、启动服务，测试，如果启动报错，需要去<code>hm-common</code>中的<code>MqConfig</code>类上面使用<code>@ConditionalOnClass(RabbitTemplate.class)</code>，表示有RabbitTemplate类的服务才让MqConfig类生效。  </p>
<h3 id="6、抽取MQ工具"><a href="#6、抽取MQ工具" class="headerlink" title="6、抽取MQ工具"></a>6、抽取MQ工具</h3><p>MQ在企业开发中的常见应用我们就学习完毕了，除了收发消息以外，消息可靠性的处理、生产者确认、消费者确认、延迟消息等等编码还是相对比较复杂的。<br>因此，我们需要将这些常用的操作封装为工具，方便在项目中使用。要求如下：  </p>
<ul>
<li>将RabbitMQ的yaml配置抽取到nacos中，作为共享配置，替换所有微服务中的自定义MQ配置</li>
<li>在hm-commom模块下编写发送消息的工具类RabbitMqHelper</li>
<li>定义一个自动配置类MqConsumeErrorAutoConfiguration，内容包括：<ul>
<li>声明一个交换机，名为error.direct，类型为direct</li>
<li>声明一个队列，名为：微服务名 + error.queue，也就是说要动态获取</li>
<li>将队列与交换机绑定，绑定时的RoutingKey就是微服务名</li>
<li>声明RepublishMessageRecoverer，消费失败消息投递到上述交换机</li>
<li>给配置类添加条件，当spring.rabbitmq.listener.simple.retry.enabled为true时触发</li>
</ul>
</li>
</ul>
<p>具体步骤：<br>1、抽取共享配置<br>首先，我们需要在nacos中抽取RabbitMQ的共享配置，命名为shared-mq.yaml：  </p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/29.png" class="">  
<p>其中只包含mq的基础共享配置，内容如下：  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">$&#123;hm.mq.host:192.168.150.101&#125;</span> <span class="comment"># 主机名</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">$&#123;hm.mq.port:5672&#125;</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">$&#123;hm.mq.vhost:/hmall&#125;</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;hm.mq.un:hmall&#125;</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;hm.mq.pw:123&#125;</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>
<p>2、引入依赖<br>在hm-common模块引入要用到的一些依赖，主要包括amqp、jackson。但是不要引入starter，因为我们希望可以让用户按需引入。  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--AMQP依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Spring整合Rabbit依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--json处理--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：依赖的scope要选择provided，这样依赖仅仅是用作项目编译时不报错，真正运行时需要使用者自行引入依赖。<br>3、封装工具<br>在hm-common模块的com.hmall.common.utils包下新建一个RabbitMqHelper类：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.lang.UUID;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.concurrent.ListenableFutureCallback;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMqHelper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, Object msg)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;准备发送消息，exchange:&#123;&#125;, routingKey:&#123;&#125;, msg:&#123;&#125;&quot;</span>, exchange, routingKey, msg);</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayMessage</span><span class="params">(String exchange, String routingKey, Object msg, <span class="type">int</span> delay)</span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, msg, message -&gt; &#123;</span><br><span class="line">            message.getMessageProperties().setDelay(delay);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageWithConfirm</span><span class="params">(String exchange, String routingKey, Object msg, <span class="type">int</span> maxRetries)</span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;准备发送消息，exchange:&#123;&#125;, routingKey:&#123;&#125;, msg:&#123;&#125;&quot;</span>, exchange, routingKey, msg);</span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString(<span class="literal">true</span>));</span><br><span class="line">        cd.getFuture().addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;&gt;() &#123;</span><br><span class="line">            <span class="type">int</span> retryCount;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable ex)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;处理ack回执失败&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(CorrelationData.Confirm result)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (result != <span class="literal">null</span> &amp;&amp; !result.isAck()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;消息发送失败，收到nack，已重试次数：&#123;&#125;&quot;</span>, retryCount);</span><br><span class="line">                    <span class="keyword">if</span>(retryCount &gt;= maxRetries)&#123;</span><br><span class="line">                        log.error(<span class="string">&quot;消息发送重试次数耗尽，发送失败&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">CorrelationData</span> <span class="variable">cd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString(<span class="literal">true</span>));</span><br><span class="line">                    cd.getFuture().addCallback(<span class="built_in">this</span>);</span><br><span class="line">                    rabbitTemplate.convertAndSend(exchange, routingKey, msg, cd);</span><br><span class="line">                    retryCount++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, msg, cd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、自动装配<br>最后，我们在hm-common模块的包下定义一个配置类，将RabbitMqHelper注册为Bean：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.hmall.common.utils.RabbitMqHelper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.support.converter.MessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(value = &#123;MessageConverter.class, RabbitTemplate.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(ObjectMapper.class)</span></span><br><span class="line">    <span class="keyword">public</span> MessageConverter <span class="title function_">messageConverter</span><span class="params">(ObjectMapper mapper)</span>&#123;</span><br><span class="line">        <span class="comment">// 1.定义消息转换器</span></span><br><span class="line">        <span class="type">Jackson2JsonMessageConverter</span> <span class="variable">jackson2JsonMessageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonMessageConverter</span>(mapper);</span><br><span class="line">        <span class="comment">// 2.配置自动创建消息id，用于识别不同消息</span></span><br><span class="line">        jackson2JsonMessageConverter.setCreateMessageIds(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> jackson2JsonMessageConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitMqHelper <span class="title function_">rabbitMqHelper</span><span class="params">(RabbitTemplate rabbitTemplate)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RabbitMqHelper</span>(rabbitTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为是在公共包下的，spring是扫描不到的，所以为了让我们的配置生效，我们需要在项目的classpath下的META-INF&#x2F;spring.factories文件中声明这个配置类：  </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MyBatisConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MqConfig,\</span></span><br><span class="line"><span class="string">  com.hmall.common.config.MvcConfig</span></span><br></pre></td></tr></table></figure>
<p>至此，RabbitMQ的工具类和自动装配就完成了。  </p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar/avatar.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar/avatar.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">十七</div><div class="post-copyright__author_desc">积少成多，只要学不死就往死里学v👀</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://zc-zjy.github.io/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://zc-zjy.github.io/2024/11/27/SpringCloud学习笔记/')">SpringCloud学习笔记</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/reward/zjyzanshang.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/zjyzanshang.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/reward/zjyzfb.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/zjyzfb.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://zc-zjy.github.io/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=SpringCloud学习笔记&amp;url=https://zc-zjy.github.io/2024/11/27/SpringCloud%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/&amp;pic=/img/page_background/cover_background_light.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zc-zjy.github.io" target="_blank">小Z成长录😀丶</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>工作技能<span class="tagsPageCount">44</span></a><a class="post-meta__box__tags" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>后端<span class="tagsPageCount">28</span></a><a class="post-meta__box__tags" href="/tags/Spring/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Spring<span class="tagsPageCount">8</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/page_background/cover_background_light.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/11/22/Springboot%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Springboot日志框架学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/2024/12/18/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">消息队列学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2023/10/04/%E5%85%B3%E4%BA%8ESpring%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="关于Spring学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-04</div><div class="title">关于Spring学习笔记</div></div></a></div><div><a href="/2023/10/09/%E5%85%B3%E4%BA%8EspringMVC%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="关于springMVC学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-09</div><div class="title">关于springMVC学习笔记</div></div></a></div><div><a href="/2024/01/31/%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/" title="常用注解"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-01-31</div><div class="title">常用注解</div></div></a></div><div><a href="/2023/10/24/Springboot%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Springboot学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-10-24</div><div class="title">Springboot学习笔记</div></div></a></div><div><a href="/2024/09/03/SpringSecurity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="SpringSecurity学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-03</div><div class="title">SpringSecurity学习笔记</div></div></a></div><div><a href="/2024/11/22/Springboot%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Springboot日志框架学习笔记"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/page_background/cover_background_light.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-11-22</div><div class="title">Springboot日志框架学习笔记</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/avatar/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description">喜欢分享，也喜欢交朋友，正在努力钻研java、spring全家桶、前端vue等等技术，梦想成为一名技术大牛</div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%9E%B6%E6%9E%84%E4%BD%93%E7%B3%BB"><span class="toc-number">1.</span> <span class="toc-text">一、架构体系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81SpringCloud%E7%BB%84%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text">二、SpringCloud组件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8D%95%E4%BD%93%E6%BC%94%E5%8F%98%E4%B8%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%BF%87%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">三、单体演变为微服务过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%BD%93%E7%B3%BB"><span class="toc-number">4.</span> <span class="toc-text">四、微服务架构体系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">五、其他问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">5.0.1.</span> <span class="toc-text">1、雪崩问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.0.2.</span> <span class="toc-text">2、分布式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">5.0.3.</span> <span class="toc-text">3、消息队列的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%A4%84%E7%90%86MQ%E6%B6%88%E6%81%AF%E9%87%8D%E5%A4%8D%E6%8A%95%E9%80%92%E9%97%AE%E9%A2%98"><span class="toc-number">5.0.4.</span> <span class="toc-text">4、处理MQ消息重复投递问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E4%BD%BF%E7%94%A8%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E6%8F%92%E4%BB%B6"><span class="toc-number">5.0.5.</span> <span class="toc-text">5、使用延迟消息插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%8A%BD%E5%8F%96MQ%E5%B7%A5%E5%85%B7"><span class="toc-number">5.0.6.</span> <span class="toc-text">6、抽取MQ工具</span></a></li></ol></li></ol></li></ol></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><img class="workSituationImg boardsign" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/footer/shangban.jpg" alt="上班摸鱼中~" title="上班摸鱼中~"/><div id="runtimeTextTip"></div></div></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2025 By <a class="footer-bar-link" href="/" title="十七" target="_blank">十七</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  if (true) { 
    window.typed = new Typed("#footer-type-tips", {
      strings: ["积少成多，只要学不死就往死里学v👀"],
      startDelay: 300,
      typeSpeed: 150,
      loop: false,
      backSpeed: 50
    })
  } else {
    document.getElementById("footer-type-tips").innerHTML = '积少成多，只要学不死就往死里学v👀'
  }
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" href="/" title="还没备案喔~">还没备案喔~</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Camunda/" style="font-size: 0.88rem;">Camunda<sup>1</sup></a><a href="/tags/ElasticSearch/" style="font-size: 0.88rem;">ElasticSearch<sup>1</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>1</sup></a><a href="/tags/IntelliJ-IDEA-2020-3-3-x64%E6%BF%80%E6%B4%BB%E6%96%B9%E6%B3%95/" style="font-size: 0.88rem;">IntelliJ IDEA 2020.3.3 x64激活方法<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>15</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/Maven/" style="font-size: 0.88rem;">Maven<sup>1</sup></a><a href="/tags/Mybatis/" style="font-size: 0.88rem;">Mybatis<sup>1</sup></a><a href="/tags/MybatisPlus/" style="font-size: 0.88rem;">MybatisPlus<sup>2</sup></a><a href="/tags/Mysql/" style="font-size: 0.88rem;">Mysql<sup>1</sup></a><a href="/tags/Postgresql/" style="font-size: 0.88rem;">Postgresql<sup>1</sup></a><a href="/tags/Postman/" style="font-size: 0.88rem;">Postman<sup>1</sup></a><a href="/tags/SVN/" style="font-size: 0.88rem;">SVN<sup>1</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem;">Spring<sup>8</sup></a><a href="/tags/Vue/" style="font-size: 0.88rem;">Vue<sup>1</sup></a><a href="/tags/css/" style="font-size: 0.88rem;">css<sup>1</sup></a><a href="/tags/navicat/" style="font-size: 0.88rem;">navicat<sup>1</sup></a><a href="/tags/%E4%B9%A6%E6%9C%AC%E7%9F%A5%E8%AF%86/" style="font-size: 0.88rem;">书本知识<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 0.88rem;">前端<sup>3</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>28</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%8A%80%E8%83%BD/" style="font-size: 0.88rem;">工作技能<sup>44</sup></a><a href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/" style="font-size: 0.88rem;">工作流<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">数据库<sup>4</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/" style="font-size: 0.88rem;">服务器<sup>3</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">测试工具<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 0.88rem;">消息队列<sup>1</sup></a><a href="/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" style="font-size: 0.88rem;">版本控制<sup>2</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">设计模式<sup>2</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("09/17/2023 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2023 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 十七 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("09/17/2023 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "/img/footer/xiaban.jpg";
        img.title = "下班啦啦啦啦，嘿嘿~";
        img.alt = "下班啦啦啦啦，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="//at.alicdn.com/t/c/font_4240673_wweo9mtor0h.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="true" data-text="I,LOVE,YOU,黄洁,十七,小Z,早上好鸭👋, 祝你一天好心情！,上午好👋, 状态很好，鼓励一下～,11点多啦, 在坚持一下就吃饭啦～,午安👋, 宝贝,🌈充实的一天辛苦啦！,奖励一顿丰盛的大餐吧🍔,晚上好👋,晚上好👋, 在属于自己的时间好好放松😌~,晚安😴" data-fontsize="15px" data-random="true" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>